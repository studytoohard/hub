<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>图雀社区</title>
  
  <subtitle>汇集精彩的实战技术教程</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://tuture.co/"/>
  <updated>2019-10-23T08:52:55.509Z</updated>
  <id>https://tuture.co/</id>
  
  <author>
    <name>图雀社区</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用 Vue 和 Node 开发一个迷你淘宝(二)</title>
    <link href="https://tuture.co/2019/10/21/cb08dc8/"/>
    <id>https://tuture.co/2019/10/21/cb08dc8/</id>
    <published>2019-10-21T00:00:00.509Z</published>
    <updated>2019-10-23T08:52:55.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p>我们在现实生活中所用到的一些网站、App，它们会将我们的数据进行保存，当我们关闭这些网站或者 App 之后，下次打开还能看到我们之前的一些文字、视频记录。</p><a id="more"></a><p>想要完成上面这些现实生活中应用的功能仅仅有我们在第一节中学到的知识是不够，为了让我们的迷你淘宝能够记录我们添加的商品，并且无论以后什么时候打开，都能获取我们之前的记录，我们需要 Vue 应用与后端进行交互。</p><p>接下来我将手把手带大家实现一个基于 Node 的 Express API后台应用。</p><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p>安装 Node.js，你可以去 <span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnL2VuLw==" title="https://nodejs.org/en/">Node.js<i class="fa fa-external-link"></i></span> 官网下载安装包，Node.js 是跨平台的，所以不用担心你的电脑无法使用。</p><p>通过 Node.js 安装包安装，会同时安装 Node.js 包管理工具 Npm，用于便捷的管理项目依赖和下载第三方包。</p><p>打开终端，输入如下命令测试是否安装成功：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node -v <span class="comment"># v10.16.0</span></span><br><span class="line">npm -v <span class="comment"># 6.9.0</span></span><br></pre></td></tr></table></figure><p>如果在你的终端有如上输出，那么代表你安装成功。</p><blockquote><p>提示：通过上面安装包安装，你会安装最新的 Node 稳定版本，这可能和我的机器上的 Node 版本不一致，但是不用担心，本教程使用到的代码语法适用于绝大多数新的或更老的 Node。</p></blockquote><p>安装 express，在绝大多数场景下，我们使用 express-generator 来初始化我们的 express 项目，本教程也不例外，在终端运行如下命令来安装：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install -g express-generator</span><br></pre></td></tr></table></figure><p>打开终端，输入如下命令测试是否安装成功：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">express --version <span class="comment"># 4.15.5</span></span><br></pre></td></tr></table></figure><p>上面两个安装步骤已经足够完成我们的教程的学习，但是我想额外推荐你一款编辑器，VSCode，你可以通过访问 <span class="exturl" data-url="aHR0cHM6Ly9jb2RlLnZpc3VhbHN0dWRpby5jb20v" title="https://code.visualstudio.com/">VSCode<i class="fa fa-external-link"></i></span> 官网安装。</p><p>VSCode 是一款非常优秀的开源编辑器，对 Node.js 开发者非常友好，相信你用了它就会爱不释手。</p><h2 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h2><p>打开终端输入如下命令初始化我们的 Express 项目：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">express --view=pug vue-online-shop-backend</span><br></pre></td></tr></table></figure><p>当项目初始化成功之后，接下来通过如下命令开启项目：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># code vue-online-shop-backend # 如果你使用了 VSCode 编辑器，可以用这行命令打开项目</span></span><br><span class="line"><span class="built_in">cd</span> vue-online-shop-backend</span><br><span class="line">npm install</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure><p>接着打开浏览器，输入 <code>http://localhost:3000/</code> 查看我们初始好的项目效果。</p><p><img alt="Exprees Hello World" data-src="./f6399092aa34edf6f8e6140f404edcab"></p><h2 id="初探初始化代码"><a href="#初探初始化代码" class="headerlink" title="初探初始化代码"></a>初探初始化代码</h2><p>通过  express-generator 初始化的项目代码中，我们在整个教程中只需要了解下面四个文件：</p><ul><li><code>app.js</code></li><li><code>bin/www</code></li><li><code>routes/index.js</code></li><li><code>views/index.ejs</code></li></ul><p>express 主要三个部分：</p><ul><li>路由：routes</li><li>中间件：middlewares</li><li>模板引擎：template engine</li></ul><p>因为我们是前后端分离的项目，所以这里我们并不需要模板引擎。</p><blockquote><p>什么是前后端分离？就是后端只提供和处理数据，不渲染前端代码。</p></blockquote><p>我们先来看一下 <code>app.js</code> 如下：</p><figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> favicon = <span class="built_in">require</span>(<span class="string">'serve-favicon'</span>);</span><br><span class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// view engine setup</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// uncomment after placing your favicon in /public</span></span><br><span class="line"><span class="comment">//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')));</span></span><br><span class="line">app.use(logger(<span class="string">'dev'</span>));</span><br><span class="line">app.use(bodyParser.json());</span><br><span class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.use(cookieParser());</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span>, index);</span><br><span class="line">app.use(<span class="string">'/users'</span>, users);</span><br><span class="line"></span><br><span class="line"><span class="comment">// catch 404 and forward to error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Not Found'</span>);</span><br><span class="line">  err.status = <span class="number">404</span>;</span><br><span class="line">  next(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// set locals, only providing error in development</span></span><br><span class="line">  res.locals.message = err.message;</span><br><span class="line">  res.locals.error = req.app.get(<span class="string">'env'</span>) === <span class="string">'development'</span> ? err : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render the error page</span></span><br><span class="line">  res.status(err.status || <span class="number">500</span>);</span><br><span class="line">  res.render(<span class="string">'error'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure><p>开头是一堆导包，然后通过调用 <code>express()</code> 初始化 express 实例，接着我们设置了模板引擎为 <code>ejs</code>，以及模板引擎的存放目录，然后就是一系列中间件的加载使用，最后导出 express 实例，丢给我们的  <code>bin/www</code> 进行调用并启动服务器。</p><p>这里我们可以看到，我们导入的两个路由 <code>index</code> 和 <code>users</code>，也和其他中间件一样被处理，所以在 express 中 “一切皆中间件”。</p><p>再来看一下 <code>bin/www</code> ，这个文件就是我们的 express 入口文件，在这个文件里导入了 express 实例 <code>app</code>，然后创建 Node.js 开发服务器，并监听端口，如果没有特殊指导，那么将监听 <code>3000</code> 端口，这也就是为什么我们在开头浏览器里面打开 <code>http://localhost:3000/</code> 的原因。</p><figure class="highlight plain"><figcaption><span>bin/www</span></figcaption><table><tr><td class="code"><pre><span class="line">#!/usr/bin/env node</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Module dependencies.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">var app = require(&apos;../app&apos;);</span><br><span class="line">var debug = require(&apos;debug&apos;)(&apos;api:server&apos;);</span><br><span class="line">var http = require(&apos;http&apos;);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Get port from environment and store in Express.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">var port = normalizePort(process.env.PORT || &apos;3000&apos;);</span><br><span class="line">app.set(&apos;port&apos;, port);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Create HTTP server.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">var server = http.createServer(app);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Listen on provided port, on all network interfaces.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">server.listen(port);</span><br><span class="line">server.on(&apos;error&apos;, onError);</span><br><span class="line">server.on(&apos;listening&apos;, onListening);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Normalize a port into a number, string, or false.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">function normalizePort(val) &#123;</span><br><span class="line">  var port = parseInt(val, 10);</span><br><span class="line"></span><br><span class="line">  if (isNaN(port)) &#123;</span><br><span class="line">    // named pipe</span><br><span class="line">    return val;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (port &gt;= 0) &#123;</span><br><span class="line">    // port number</span><br><span class="line">    return port;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Event listener for HTTP server &quot;error&quot; event.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">function onError(error) &#123;</span><br><span class="line">  if (error.syscall !== &apos;listen&apos;) &#123;</span><br><span class="line">    throw error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  var bind = typeof port === &apos;string&apos;</span><br><span class="line">    ? &apos;Pipe &apos; + port</span><br><span class="line">    : &apos;Port &apos; + port;</span><br><span class="line"></span><br><span class="line">  // handle specific listen errors with friendly messages</span><br><span class="line">  switch (error.code) &#123;</span><br><span class="line">    case &apos;EACCES&apos;:</span><br><span class="line">      console.error(bind + &apos; requires elevated privileges&apos;);</span><br><span class="line">      process.exit(1);</span><br><span class="line">      break;</span><br><span class="line">    case &apos;EADDRINUSE&apos;:</span><br><span class="line">      console.error(bind + &apos; is already in use&apos;);</span><br><span class="line">      process.exit(1);</span><br><span class="line">      break;</span><br><span class="line">    default:</span><br><span class="line">      throw error;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Event listener for HTTP server &quot;listening&quot; event.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">function onListening() &#123;</span><br><span class="line">  var addr = server.address();</span><br><span class="line">  var bind = typeof addr === &apos;string&apos;</span><br><span class="line">    ? &apos;pipe &apos; + addr</span><br><span class="line">    : &apos;port &apos; + addr.port;</span><br><span class="line">  debug(&apos;Listening on &apos; + bind);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们的 <code>app.js</code> 和 <code>bin/www</code> 文件里面还要很多其他代码，这里我们没有仔细去探究，因为我们的教程着重讲解 Vue 的知识点，而我们的后端完全是为了服务于如何探求 Vue 与后端交互，所以这里只讲解如何搭建一个 API 服务器，不了解这些 “样板” 代码其实对于搭建我们的 API 服务器没有太大的影响，具体学习我们后面会出一个以讲解 Node &amp; Express 基础为核心的教程，敬请期待！</p><p>让我们再来看一看我们的路由部分 <code>routes/index.js</code>，路由是我们 API 服务器的核心，我们对数据进行增删改查都需要访问特定的路由接口，我们在整个教程中几乎都是围绕路由的操作。</p><figure class="highlight js"><figcaption><span>routes/index.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>上面的代码，首先导入 <code>express</code>，然后使用其属性方法生成了一个  <code>router</code> 实例，接着定义了 <code>get</code> 这一 HTTP 方法来处理以 <code>GET</code> 方法访问我们服务器地址为 <code>/</code> 时如何进行处理。</p><p>我们的 API 服务器实际上就是通过 HTTP 的各种方法（POST、DELETE、PUT、GET 等）访问我们定义的路由，进而对数据库进行相应的增删改查操作以获取我们期望的数据。</p><p>这里 <code>express-generator</code> 脚手架为我们生成的代码中单纯的渲染了我们的 <code>index.ejs</code> 模板，并给模板引擎传入了 <code>title</code> 为 <code>Express</code> 的参数。</p><p>最后导出我们的 <code>index</code> 路由。</p><p>最后是我们的 <code>index.ejs</code> ，这个就是我们访问 <code>index</code> 路由时渲染的模板，<code>title</code> 就是我们上面传入的 <code>&quot;Express&quot;</code> 字符串 。</p><figure class="highlight plain"><figcaption><span>views/index.ejs</span></figcaption><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;</span><br><span class="line">    &lt;link rel=&apos;stylesheet&apos; href=&apos;/stylesheets/style.css&apos; /&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;Welcome to &lt;%= title %&gt;&lt;/p&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>通过简单的讲解 <code>express-generator</code> 脚手架为我们生成的上面四个文件，我们学到了如下知识：</p><ul><li>在 Express 中，一切皆中间件（Middlewares），我们通过组合中间件来处理复制的后端逻辑。</li><li>我们的 API 服务器实际上就是通过定义一系列路由，当以不同的 HTTP 方法访问这些路由接口时，对数据进行对应的增删改查操作。</li><li>虽然 Express 也可以渲染模板引擎，展示 HTML 内容，但是我们的 API 服务器不需要用到它，我们的前端交给了 Vue 来做。</li></ul><h2 id="接入-MongoDB-数据库"><a href="#接入-MongoDB-数据库" class="headerlink" title="接入 MongoDB 数据库"></a>接入 MongoDB 数据库</h2><p>在我们的<a href="https://tuture.co/hub/2019/10/22/%E4%BD%BF%E7%94%A8%20Vue%20%E5%92%8C%20Node%20%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E8%BF%B7%E4%BD%A0%E6%B7%98%E5%AE%9D(%E4%B8%80)/">第一篇教程</a>中，我们在前端硬编码了一些假数据，虽然这使得我们每次打开我们的 Vue 应用可以一样的效果，但是当我们对数据做出了修改，并在下一次打开时，会发现，我们的网站像“失忆”了一样。</p><p>解决数据持久化存储最流行的方案无疑是数据库，而 MongoDB 凭借其优异的性能、可扩展性和灵活的数据模式，从众多数据库产品中脱颖而出。并且，MongoDB 的核心功能是基于 BSON（Binary JSON）实现的，甚至提供了 JavaScript Shell，因此在 Node 社区更是深受欢迎。所以，我们也将利用 MongoDB 实现 Instagrammy 的数据持久化存储。MongoDB 可以从其<span class="exturl" data-url="aHR0cHM6Ly93d3cubW9uZ29kYi5jb20vZG93bmxvYWQtY2VudGVyL2NvbW11bml0eQ==" title="https://www.mongodb.com/download-center/community">官网<i class="fa fa-external-link"></i></span>上下载。下载并安装好之后，新打开一个终端（命令控制台），运行以下命令打开数据库（Windows 用户可以搜索 mongo.exe 并打开）：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongod</span><br></pre></td></tr></table></figure><p>然后我们安装 Mongoose 这个 npm 包：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install mongoose</span><br></pre></td></tr></table></figure><p>Mongoose 是 MongoDB 最流行的 ODM（Object Document Mapping，对象文档映射），使用起来要比底层的 MongoDB Node 驱动更方便。</p><figure class="highlight"><figcaption><span>package.json</span></figcaption><table><tr><td class="code"><pre><span class="line">    "debug": "~2.6.9",</span><br><span class="line">    "ejs": "~2.5.7",</span><br><span class="line">    "express": "~4.15.5",</span><br><span class="line">[tuture-add]    "mongoose": "^5.7.5",</span><br><span class="line">    "morgan": "~1.9.0",</span><br><span class="line">    "serve-favicon": "~2.4.5"</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>接着我们在我们的 <code>app.js</code> 文件中导入 <code>mongoose</code> ，并且通过 <code>mongoose</code> 提供的接口连接我们的 MongoDB 数据库</p><figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">[tuture-del]<span class="keyword">var</span> favicon = <span class="built_in">require</span>(<span class="string">'serve-favicon'</span>);</span><br><span class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line">[tuture-omit]</span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line">[tuture-add]<span class="comment">// Datbase connection here</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]mongoose.connect(<span class="string">`mongodb://localhost:27017/test`</span>);</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]</span><br><span class="line"><span class="comment">// uncomment after placing your favicon in /public</span></span><br><span class="line"><span class="comment">//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')));</span></span><br><span class="line">app.use(logger(<span class="string">'dev'</span>));</span><br></pre></td></tr></table></figure><p>接着我们的终端中切换到此项目根目录下，通过 <code>npm start</code> 运行我们的服务器，我们就在 Express 中连接上了我们的 MongoDB 数据库，虽然现在还看不到任何效果，我们马上会编写路由来操作数据库来测试连接的有效性。</p><h2 id="允许资源跨域访问"><a href="#允许资源跨域访问" class="headerlink" title="允许资源跨域访问"></a>允许资源跨域访问</h2><p>接着我们要做一点额外的操作，尽管它看起来和我们的项目没什么关联性，但是确是一个必要的一环，那就是开启 CORS。</p><p>我们打开 <code>app.js</code> 文件，添加如下代码：</p><figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="code"><pre><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Datbase connection here</span></span><br><span class="line">[tuture-del]</span><br><span class="line">mongoose.connect(<span class="string">`mongodb://localhost:27017/test`</span>);</span><br><span class="line"></span><br><span class="line">[tuture-add]<span class="comment">// CORS config here</span></span><br><span class="line">[tuture-add]app.all(<span class="string">'/*'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">[tuture-add]  <span class="comment">// CORS headers</span></span><br><span class="line">[tuture-add]  res.header(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>); <span class="comment">// restrict it to the required domain</span></span><br><span class="line">[tuture-add]  res.header(<span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'GET,PUT,POST,DELETE,OPTIONS'</span>);</span><br><span class="line">[tuture-add]  <span class="comment">// Set custom headers for CORS</span></span><br><span class="line">[tuture-add]  res.header(<span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'Content-type,Accept,X-Access-Token,X-Key'</span>);</span><br><span class="line">[tuture-add]  <span class="keyword">if</span> (req.method == <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">[tuture-add]    res.status(<span class="number">200</span>).end();</span><br><span class="line">[tuture-add]  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">[tuture-add]    next();</span><br><span class="line">[tuture-add]  &#125;</span><br><span class="line">[tuture-add]&#125;);</span><br><span class="line">[tuture-add]</span><br><span class="line"></span><br><span class="line"><span class="comment">// uncomment after placing your favicon in /public</span></span><br><span class="line"><span class="comment">//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')));</span></span><br></pre></td></tr></table></figure><p>CORS （Cross-Origin Resources Sharing）是用来限制此域名下的资源访问解决方案，当它关闭时，另外一个域名访问此域名的资源时会被拒绝。如果想详细了解什么是 CORS，这里推荐一篇<span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTYvMDQvY29ycy5odG1s" title="http://www.ruanyifeng.com/blog/2016/04/cors.html">阮一峰<i class="fa fa-external-link"></i></span>的文章，里面很细致的讲解了 CORS 的原理。</p><p>通常意义上，上面的代码存在很多问题，我们一般意义上会使用 <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvY29ycw==" title="https://www.npmjs.com/package/cors">NPM<i class="fa fa-external-link"></i></span> 包 <code>cors</code> 来解决，当然我们这里使用了比较简单粗暴的方式。</p><h2 id="设计数据库的-Schemas-和-Models"><a href="#设计数据库的-Schemas-和-Models" class="headerlink" title="设计数据库的 Schemas 和 Models"></a>设计数据库的 Schemas 和 Models</h2><p>我们要在服务器中通过 mongoose 与 MongoDB 数据库进行交互，需要定义 <code>Schema</code> 和  <code>Model</code>。通过定义它们来告诉 mongoose 你需要的数据结构和对应的数据类型是什么。</p><p>我们来创建 <code>model/index.js</code> 文件编写我们的 <code>Schema</code> 。</p><figure class="highlight js"><figcaption><span>model/index.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> Schema = mongoose.Schema;</span><br><span class="line"><span class="keyword">const</span> model = mongoose.model.bind(mongoose);</span><br><span class="line"><span class="keyword">const</span> ObjectId = mongoose.Schema.Types.ObjectId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> productSchema = Schema(&#123;</span><br><span class="line">  id: ObjectId,</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  image: <span class="built_in">String</span>,</span><br><span class="line">  price: <span class="built_in">Number</span>,</span><br><span class="line">  description: <span class="built_in">String</span>,</span><br><span class="line">  manufacturer: &#123; <span class="attr">type</span>: ObjectId, <span class="attr">ref</span>: <span class="string">'Manufacturer'</span> &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> manufacturerSchema = Schema(&#123;</span><br><span class="line">  id: ObjectId,</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Product = model(<span class="string">'Product'</span>, productSchema);</span><br><span class="line"><span class="keyword">const</span> Manufacturer = model(<span class="string">'Manufacturer'</span>, manufacturerSchema);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; Product, Manufacturer &#125;;</span><br></pre></td></tr></table></figure><p><code>Schema</code> 接收一个 JavaScript 对象来描述我们需要的数据结构和对应的数据类型，除了我们熟知的像 <code>String</code>、<code>Number</code> 等数据类型外，<code>ObjectId</code> 是一个特殊的数据类型，我们用它来定义我们的单个 MongoDB 文档的主键，用于标志存储数据的唯一性。</p><p>我们还可以看到，在我们的 <code>productSchema</code> 中，<code>manufacturer</code> 数据结构我们定义了一个 <code>ref</code> 属性，这是 MongoDB 为我们提供的类似关系数据库的外键功能，允许我们创建一对多的数据文档，所以 <code>productSchema</code> 的 <code>manufacturer</code> 属性对应着的数据类型为一条 <code>Manufacturer</code> 记录。</p><p>接着我们通过 <code>model</code> 来创建对于的数据模型，然后导出我们创建好的数据模型。这里的 <code>model</code> 就是经典的 MVC 设计模式中的 <strong>Model</strong></p><h2 id="完成-API-路由"><a href="#完成-API-路由" class="headerlink" title="完成 API 路由"></a>完成 API 路由</h2><p>路由是 Express 的关键组成部分，也是客户端与服务器进行交互的入口，在 Express 路由中接受两个参数：Request 和 Response，一个用来获取客户端的请求，一个用来发送给客户端服务器的响应。</p><p>打开 <code>app.js</code> 文件，加入如下代码：</p><figure class="highlight js"><figcaption><span>app.js</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> api = <span class="built_in">require</span>(<span class="string">'./routes/api'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">[tuture-omit]</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span>, index);</span><br><span class="line">app.use(<span class="string">'/users'</span>, users);</span><br><span class="line">[tuture-add]app.use(<span class="string">'/api/v1'</span>, api);</span><br><span class="line"></span><br><span class="line"><span class="comment">// catch 404 and forward to error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br></pre></td></tr></table></figure><p>可以看到，我们导出了 <code>api</code> 路由，并定义了访问路径 <code>/api/v1</code>。所有访问 <code>/api/v1</code> 及其子路径如 <code>/api/v1/xxx</code> 都会激活 <code>api</code> 处理函数，在经典的 MVC 设计模式中，<code>api</code>  也被成为 <strong>Controllers</strong> 。</p><p>接着我们编写 <code>api</code> Controllers，在这里面定义操作商品和制造商的路由接口，这里我们将采用经典的 <span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTgvMTAvcmVzdGZ1bC1hcGktYmVzdC1wcmFjdGljZXMuaHRtbA==" title="http://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html">RESTful API <i class="fa fa-external-link"></i></span>来编写我们的路由接口：</p><figure class="highlight js"><figcaption><span>routes/api/index.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> productController = <span class="built_in">require</span>(<span class="string">'../../controllers/product'</span>);</span><br><span class="line"><span class="keyword">const</span> manufacturerController = <span class="built_in">require</span>(<span class="string">'../../controllers/manufacturer'</span>);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/manufacturers'</span>, manufacturerController.all);</span><br><span class="line">router.get(<span class="string">'/manufacturers/:id'</span>, manufacturerController.byId);</span><br><span class="line">router.post(<span class="string">'/manufacturers'</span>, manufacturerController.create);</span><br><span class="line">router.put(<span class="string">'/manufacturers/:id'</span>, manufacturerController.update);</span><br><span class="line">router.delete(<span class="string">'/manufacturers/:id'</span>, manufacturerController.remove);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/products'</span>, productController.all);</span><br><span class="line">router.get(<span class="string">'/products/:id'</span>, productController.byId);</span><br><span class="line">router.post(<span class="string">'/products'</span>, productController.create);</span><br><span class="line">router.put(<span class="string">'/products/:id'</span>, productController.update);</span><br><span class="line">router.delete(<span class="string">'/products/:id'</span>, productController.remove);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>可以看到，我们将 <code>index</code> Controller 里面导入了我们的 <code>productController</code> 和 <code>manufacturerController</code> 。然后定义了一系列路由。</p><p>这里操作 <code>manufacturer</code> 的前五个路由的功能如下：</p><ul><li><code>GET /manufacturers</code> 获取所以的制造商（manufacturers） </li><li><code>GET /manufacturers/:id</code> 获取单个制造商，这里 <code>:id</code> 代表动态路由，用于匹配任意字符串：<code>/manufacturers/&lt;any-string&gt;</code>。</li><li><code>POST /manufacturers</code> 用户创建单个制造商</li><li><code>PUT /manufacturers/:id</code> 用于修改单个制造商</li><li><code>DELETE /manufacturers/:id</code> 用于删除单个制造商</li></ul><p>对应的 <code>product</code> 的五个路由功能如下：</p><ul><li><code>GET /products</code> 获取所以的产商品（products） </li><li><code>GET /products/:id</code> 获取单个商品，这里 <code>:id</code> 代表动态路由，用于匹配任意字符串：<code>/products/&lt;any-string&gt;</code>。</li><li><code>POST /products</code> 用户创建单个商品</li><li><code>PUT /products/:id</code> 用于修改单个商品</li><li><code>DELETE /products/:id</code> 用于删除单个商品</li></ul><p>最后我们导出我们的路由。</p><p>接下来我们来看一看具体的 <code>manufacturer</code> Controller。</p><figure class="highlight js"><figcaption><span>controllers/manufacturer.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Model = <span class="built_in">require</span>(<span class="string">'../model'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; Manufacturer &#125; = Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> manufacturerController = &#123;</span><br><span class="line">  all(req, res) &#123;</span><br><span class="line">    Manufacturer.find(&#123;&#125;)</span><br><span class="line">      .exec(<span class="function">(<span class="params">err, manfacturers</span>) =&gt;</span> res.json(manfacturers))</span><br><span class="line">  &#125;,</span><br><span class="line">  byId(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> idParams = req.params.id;</span><br><span class="line"></span><br><span class="line">    Manufacturer</span><br><span class="line">      .findOne(&#123; <span class="attr">_id</span>: idParams &#125;)</span><br><span class="line">      .exec(<span class="function">(<span class="params">err, manufacturer</span>) =&gt;</span> res.json(manufacturer));</span><br><span class="line">  &#125;,</span><br><span class="line">  create(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> requestBody = req.body;</span><br><span class="line">    <span class="keyword">const</span> newManufacturer = <span class="keyword">new</span> Manufacturer(requestBody);</span><br><span class="line"></span><br><span class="line">    newManufacturer.save(<span class="function">(<span class="params">err, saved</span>) =&gt;</span> &#123;</span><br><span class="line">      Manufacturer</span><br><span class="line">        .findOne(&#123; <span class="attr">_id</span>: newManufacturer._id &#125;)</span><br><span class="line">        .exec(<span class="function">(<span class="params">err, manfacturer</span>) =&gt;</span> res.json(manfacturer))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  update(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> idParams = req.params.id;</span><br><span class="line">    <span class="keyword">let</span> manufacturer = req.body;</span><br><span class="line"></span><br><span class="line">    Manufacturer.updateOne(&#123; <span class="attr">_id</span>: idParams &#125;, &#123; ...manufacturer &#125;, (err, updated) =&gt; &#123;</span><br><span class="line">      res.json(updated);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  remove(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> idParams = req.params.id;</span><br><span class="line"></span><br><span class="line">    Manufacturer.findOne(&#123; <span class="attr">_id</span>: idParams &#125;).remove( <span class="function">(<span class="params">err, removed</span>) =&gt;</span> res.json(idParams) )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = manufacturerController;</span><br></pre></td></tr></table></figure><p>可以看到我们定义了一个 <code>manufacturerController</code> 对象，用来组织一系列对 <code>manufacturer</code> 进行增删改查的操作。</p><p>我们在开头导入了我们之前定义的 <code>ManufacturerModel</code>，这是 Mongoose 为我们提供的操作数据库的接口，我们通过定义在 Model 上的一系列如 find、findOne、updateOne、deleteOne 执行我们对数据的增删改成操作。</p><p>最后是我们的 <code>product</code> Controller ，它内部的操作和我们上面讲到的 <code>manufacturer</code> Controller 基本一致。</p><figure class="highlight js"><figcaption><span>controllers/product.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Model = <span class="built_in">require</span>(<span class="string">'../model'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; Product &#125; = Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> productController = &#123;</span><br><span class="line">  all(req, res) &#123;</span><br><span class="line">    Product.find(&#123;&#125;)</span><br><span class="line">      .populate(<span class="string">'manufacturer'</span>)</span><br><span class="line">      .exec(<span class="function">(<span class="params">err, products</span>) =&gt;</span> res.json(products))</span><br><span class="line">  &#125;,</span><br><span class="line">  byId(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> idParams = req.params.id;</span><br><span class="line"></span><br><span class="line">    Product</span><br><span class="line">      .findOne(&#123; <span class="attr">_id</span>: idParams &#125;)</span><br><span class="line">      .populate(<span class="string">'manufacturer'</span>)</span><br><span class="line">      .exec(<span class="function">(<span class="params">err, product</span>) =&gt;</span> res.json(product));</span><br><span class="line">  &#125;,</span><br><span class="line">  create(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> requestBody = req.body;</span><br><span class="line">    <span class="keyword">const</span> newProduct = <span class="keyword">new</span> Product(requestBody);</span><br><span class="line"></span><br><span class="line">    newProduct.save(<span class="function">(<span class="params">err, saved</span>) =&gt;</span> &#123;</span><br><span class="line">      Product</span><br><span class="line">        .findOne(&#123; <span class="attr">_id</span>: newProduct._id &#125;)</span><br><span class="line">        .populate(<span class="string">'manufacturer'</span>)</span><br><span class="line">        .exec(<span class="function">(<span class="params">err, product</span>) =&gt;</span> res.json(product))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  update(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> idParams = req.params.id;</span><br><span class="line">    <span class="keyword">const</span> product = req.body;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'idParams'</span>, idParams);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'product'</span>, product);</span><br><span class="line"></span><br><span class="line">    Product.updateOne(&#123; <span class="attr">_id</span>: idParams &#125;, &#123; ...product &#125;, (err, updated) =&gt; &#123;</span><br><span class="line">      res.json(updated);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  remove(req, res) &#123;</span><br><span class="line">    <span class="keyword">const</span> idParams = req.params.id;</span><br><span class="line"></span><br><span class="line">    Product.findOne(&#123; <span class="attr">_id</span>: idParams &#125;).remove( <span class="function">(<span class="params">err, removed</span>) =&gt;</span> res.json(idParams) )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = productController;</span><br></pre></td></tr></table></figure><p>编写完上面的代码并保存，打开终端输入 <code>npm start</code> 来开启我们的服务器。</p><p>因为我们的服务器在开启时要链接 MongoDB 数据库，所以要确保本地的 MongoDB 数据库已经开启，我们可以通过如下命令来开启：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongod</span><br></pre></td></tr></table></figure><p>好了，现在我们的 API 服务器就搭建完成了，现在我们通过 API 测试工具 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2V0cG9zdG1hbi5jb20v" title="https://www.getpostman.com/">POSTman<i class="fa fa-external-link"></i></span> 来测试一下我们 API 是否成功。</p><p>测试 <code>GET /api/v1/manufacturers</code>：</p><p><img alt data-src="./89b9a7511314e56444db9f04e1fc8aa6"></p><p>测试 <code>POST /api/v1/manufacturers</code>：我们添加手机制造商 <code>&quot;一加&quot;</code></p><p><img alt data-src="./b739bcedeac40735ce6cb7e96437d7be"></p><p>测试 <code>PUT /api/v1/manufacturers/:id</code>：这里我们把 <code>&quot;一加&quot;</code> 改成 <code>&quot;One Plus&quot;</code></p><p><img alt data-src="./1b0f5b9135b8a0b95381157cef9df74d"></p><p><img alt data-src="./9ece79248ed36c94cfaa73d7fcac0fb1"></p><p>测试 <code>DELETE /api/v1/manufacturers/:id</code>：我们把刚刚添加的 <code>&quot;一加&quot;</code> 删掉</p><p><img alt data-src="./14335c49c2896d7b6c9ed4e218aebfff"></p><p><img alt data-src="./3c3a095b9887842a59c29507e366ce53"></p><p>最后测试添加商品 <code>product</code>，<code>POST /api/v1/products</code>：这里我们在定义 <code>product</code> 的数据属性时，加入了 <code>Manufacturer</code> 作为外键，所以创建的时候对应的 <code>manufacturer</code> 属性要为某个 <code>Manufacturer</code> 的 <code>ObjectId</code>，比如我们这里添加小米的新产品 <code>Mix Alpha</code> ：</p><p><img alt data-src="./c27e38b5de01eb2cc113d718fd41608c"></p><p>可以看到我们添加了 <code>manufacturer</code> 为 <code>5da72eaac6ccea32f823c247</code> 的小米制造商的新手机 <code>&quot;Mix Alpha&quot;</code></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>自此，我们的 API 服务器就搭建完成了，在这篇教程里面我们学到了如下知识：</p><ul><li>了解 Express 的路由以及如何用 mongoose 连接 MongoDB 数据库</li><li>编写路由、Model 和 Controllers</li><li>使用 POSTman 来测试我们编写的 API</li></ul><p>相信通过本篇教程的学习，你对使用 Node 和 Express 编写 API 后端服务器有了一个基本的了解，现在我们了解了 Vue 基础知识，了解了如何搭建后端服务器，接下来我们将考虑如何使用 Vue 构建大型应用，下一篇教程我们再见！</p>]]></content>
    
    <summary type="html">
    
      这是本教程的第二个部分，使用 Node.js 的 Express 路由框架来编写我们迷你淘宝的 API 后台部分，在这个教程中，你将学到一个基础的 Web 后台 API 应用如何搭建，包括中间件、路由等，如何通过 Node.js 数据库接口包操作 MongoDB 数据库，并且通过 Postman 来测试我们写好的 API。
    
    </summary>
    
    
    
      <category term="JavaScript" scheme="https://tuture.co/tags/JavaScript/"/>
    
      <category term="Vue" scheme="https://tuture.co/tags/Vue/"/>
    
      <category term="Node" scheme="https://tuture.co/tags/Node/"/>
    
      <category term="MongoDB" scheme="https://tuture.co/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>Django + Nuxt 实现美食分享网站</title>
    <link href="https://tuture.co/2019/10/18/866b179/"/>
    <id>https://tuture.co/2019/10/18/866b179/</id>
    <published>2019-10-18T00:00:00.509Z</published>
    <updated>2019-10-23T02:52:55.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h2><p>首先创建项目目录，并进入：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir recipes_app &amp;&amp; <span class="built_in">cd</span> recipes_app</span><br></pre></td></tr></table></figure><a id="more"></a><p>在这个项目中，我们用 <span class="exturl" data-url="aHR0cHM6Ly9waXBlbnYua2VubmV0aHJlaXR6Lm9yZy8=" title="https://pipenv.kennethreitz.org/">pipenv<i class="fa fa-external-link"></i></span> 来管理 Python 项目的环境依赖。Pipenv 是 Python 社区偶像级大师 Kenneth Reitz 牵头开发的开发流程优化工具，立志集所有项目管理工具（Node 的 npm、Ruby 的 bundler、PHP 的 composer 等等）的优势为一体。我们通过下面的命令安装 pipenv，并创建项目的依赖环境：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install pipenv</span><br><span class="line">$ pipenv shell</span><br></pre></td></tr></table></figure><p>如果看到命令提示符前面出现 <code>(recipes_app-nV3wuGJ1)</code> 的提示（后面那串随机字符串可能不一样），就表明我们已经成功地创建了项目独有的虚拟环境！我们接着安装 Django “三件套”：</p><ul><li><strong>Django</strong>: Django 框架本身，提供了丰富且强大的服务器开发组件；</li><li><strong>Django Rest Framework</strong>：Django 框架的超级搭档，大大方便了 REST API 的开发；</li><li><strong>Django CORS Headers</strong>：用于实现跨域资源请求（CORS）的 Django 中间件（如果你不了解 CORS，可以参考阮一峰的<span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTYvMDQvY29ycy5odG1s" title="http://www.ruanyifeng.com/blog/2016/04/cors.html">日志<i class="fa fa-external-link"></i></span>）。</li></ul><p>安装命令如下：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(recipes_app-nV3wuGJ1) $ pipenv install django django-rest-framework django-cors-headers</span><br></pre></td></tr></table></figure><p>这时 pipenv 便产生了 Pipfile 文件，它的作用就类似 Node 项目中的 package.json 文件：</p><figure class="highlight plain"><figcaption><span>Pipfile</span></figcaption><table><tr><td class="code"><pre><span class="line">[[source]]</span><br><span class="line">url = &quot;https://mirrors.aliyun.com/pypi/simple/&quot;</span><br><span class="line">verify_ssl = true</span><br><span class="line">name = &quot;pypi&quot;</span><br><span class="line"></span><br><span class="line">[packages]</span><br><span class="line">django = &quot;*&quot;</span><br><span class="line">django-rest-framework = &quot;*&quot;</span><br><span class="line">django-cors-headers = &quot;*&quot;</span><br><span class="line"></span><br><span class="line">[dev-packages]</span><br><span class="line"></span><br><span class="line">[requires]</span><br><span class="line">python_version = &quot;3.6&quot;</span><br></pre></td></tr></table></figure><p>然后用 Django 脚手架创建服务器项目 <code>api</code> 的基本结构，并进入到 <code>api</code>创建一个子应用 <code>core</code>：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(recipes_app-nV3wuGJ1) $ django-admin startproject api</span><br><span class="line">(recipes_app-nV3wuGJ1) $ <span class="built_in">cd</span> api</span><br><span class="line">(recipes_app-nV3wuGJ1) $ python manage.py startapp core</span><br></pre></td></tr></table></figure><p>此时项目结构如下所示：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">api</span><br><span class="line">├── api                      // 项目全局文件目录</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── settings.py          // 全局配置</span><br><span class="line">│   ├── urls.py              // 全局路由</span><br><span class="line">│   └── wsgi.py              // WSGI 服务</span><br><span class="line">├── core                     // core 应用目录</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── admin.py             // 后台管理配置</span><br><span class="line">│   ├── apps.py</span><br><span class="line">│   ├── migrations           // 数据库迁移文件目录</span><br><span class="line">│   │   └── __init__.py</span><br><span class="line">│   ├── models.py            // 数据模型</span><br><span class="line">│   ├── tests.py             // 单元测试</span><br><span class="line">│   ├── urls.py              // 应用路由</span><br><span class="line">│   └── views.py             // 视图</span><br><span class="line">└── manage.py                // 项目管理脚本</span><br></pre></td></tr></table></figure><p>Django 的默认项目布局如上所示，由一个<strong><em>全局项目目录</em></strong>（和项目名称同名，用于存放全局文件）、多个<strong><em>子应用目录</em></strong>（每个应用包括数据模型、视图等一整套模块）和一个<strong><em>项目管理脚本</em></strong>组成。项目管理脚本的功能包括运行服务器、单元测试、数据库迁移等等。</p><p>让我们运行 Django 服务器，确保一切正常：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(recipes_app-nV3wuGJ1) $ python manage.py runserver</span><br></pre></td></tr></table></figure><p>出现以下所示的欢迎界面（Django 2.2版本）：</p><p><img alt data-src="./django-welcome.jpg"></p><p>即便现在没有写任何代码，Django 已经悄悄为我们带来了很多酷炫的功能，特别是自带的后台管理系统。首先关闭刚才打开的服务器（Ctrl + C），然后进行数据库迁移：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(recipes_app-nV3wuGJ1) $ python manage.py migrate</span><br></pre></td></tr></table></figure><p>在这里先简单描述一下数据库迁移（Database Migration）的作用：根据定义好的数据模型，在数据库中创建相应的表格（即 SQL 中的 <code>CREATE TABLE ...</code> 命令）。Django 自身已经定义好了用户、会话等模型，因此需要先进行数据库迁移，在数据库中建表。</p><p>数据库迁移完成后，就可以创建用于登录后台管理的超级用户：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(recipes_app-nV3wuGJ1) $ python manage.py createsuperuser</span><br></pre></td></tr></table></figure><p>按照问题输入信息即可。要记住用户名和密码哦！</p><p>再次打开服务器，访问 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDAwL2FkbWlu" title="http://localhost:8000/admin">http://localhost:8000/admin<i class="fa fa-external-link"></i></span>，可以看到后台管理的登录页面。输入刚才创建的超级用户的用户名和密码，就进入了后台管理系统，如下所示：</p><p><img alt data-src="./django-admin.png"></p><p>看上去很简洁专业，但是——没什么东西，而且全是英文！别担心，后面我们会一个个搞定。</p><h2 id="用-Django-实现-REST-API"><a href="#用-Django-实现-REST-API" class="headerlink" title="用 Django 实现 REST API"></a>用 Django 实现 REST API</h2><p>接下来我们将实现本项目所需要用的所有 API。对，你没有听错，我们会在这一步实现所有后端接口，大概只 10 分钟左右可以敲完！这就是 Django 的宣言：</p><blockquote><p>The web framework for perfectionists with deadlines.</p></blockquote><p>“为赶时间的完美主义者而生！”</p><p>首先，在项目级目录的全局配置文件 settings.py 中做如下改动：</p><ol><li>在 <code>INSTALLED_APPS</code> 中添加 <code>rest_framework</code>、<code>corsheaders</code> 和 <code>core</code>，前两个分别是 Django Rest Framework 和 Django CORS Headers 的应用，最后一个是我们网站的应用；</li><li>在 <code>MIDDLEWARE</code> 中添加 <code>corsheaders.middleware.CorsMiddleware</code>，注册跨域请求中间件（<strong>注意一定要放在最前面！</strong>）;</li><li>设置 <code>CORS_ORIGIN_WHITELIST</code>，添加跨域请求白名单，这里我们先写上 <code>http://localhost:3000</code>，后面开发前端时将用到；</li><li>设置 <code>LANGUAGE_CODE</code> 为 <code>zh-hans</code>，可以将后台管理设置为中文，非常方便；</li><li>设置 <code>MEDIA_URL</code> 和 <code>MEDIA_ROOT</code>，用于在开发中提供图片资源文件的访问。</li></ol><p>具体代码如下：</p><figure class="highlight py"><figcaption><span>api/api/settings.py</span></figcaption><table><tr><td class="code"><pre><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">[tuture-add]    <span class="string">'rest_framework'</span>,</span><br><span class="line">[tuture-add]    <span class="string">'corsheaders'</span>,</span><br><span class="line">[tuture-add]    <span class="string">'core'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">[tuture-add]    <span class="string">'corsheaders.middleware.CorsMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">[tuture-omit]</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">[tuture-add]CORS_ORIGIN_WHITELIST = (</span><br><span class="line">[tuture-add]    <span class="string">'http://localhost:3000'</span>,</span><br><span class="line">[tuture-add])</span><br><span class="line">[tuture-add]</span><br><span class="line">ROOT_URLCONF = <span class="string">'api.urls'</span></span><br><span class="line"></span><br><span class="line">TEMPLATES = [</span><br><span class="line">[tuture-omit]</span><br><span class="line"><span class="comment"># Internationalization</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.0/topics/i18n/</span></span><br><span class="line"></span><br><span class="line">[tuture-<span class="keyword">del</span>]LANGUAGE_CODE = <span class="string">'en-us'</span></span><br><span class="line">[tuture-add]LANGUAGE_CODE = <span class="string">'zh-hans'</span></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">'UTC'</span></span><br><span class="line"></span><br><span class="line">[tuture-omit]</span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.0/howto/static-files/</span></span><br><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]MEDIA_URL = <span class="string">'/media/'</span></span><br><span class="line">[tuture-add]MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">'media'</span>)</span><br></pre></td></tr></table></figure><p>接下来就是实现 <code>core</code> 这个 Django 应用。实现一个 Django 应用大致都是按照这样的流程：</p><ol><li>定义数据模型（models.py），用于实现和数据库之间的绑定；</li><li>定义后台管理配置（admin.py），用于在后台管理系统中进行操作；</li><li>定义序列化器（serializers.py），<em>仅当实现 REST API 时需要</em>，用于提供数据模型的 JSON 序列化（或其他数据交换格式）；</li><li>定义视图（views.py），用于实现具体的业务逻辑（也许你在第一步就已经开始困惑了，View 不应该代表用户界面吗？实际上，在 Django 框架中，View 的作用相当于 MVC 框架中的 Controller）；</li><li>定义路由（urls.py），用于定义路由规则，将其映射到相应的视图；</li><li>将应用路由接入全局路由文件（api/urls.py）中。</li></ol><p>我们从第一步开始，完成菜谱 <code>Recipe</code> 数据模型如下：</p><figure class="highlight py"><figcaption><span>api/core/models.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">[tuture-<span class="keyword">del</span>]<span class="comment"># Create your models here.</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="class"><span class="keyword">class</span> <span class="title">Recipe</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">[tuture-add]    DIFFICULTY_LEVELS = (</span><br><span class="line">[tuture-add]        (<span class="string">'Easy'</span>, <span class="string">'容易'</span>),</span><br><span class="line">[tuture-add]        (<span class="string">'Medium'</span>, <span class="string">'中等'</span>),</span><br><span class="line">[tuture-add]        (<span class="string">'Hard'</span>, <span class="string">'困难'</span>),</span><br><span class="line">[tuture-add]    )</span><br><span class="line">[tuture-add]    name = models.CharField(max_length=<span class="number">120</span>, verbose_name=<span class="string">'名称'</span>)</span><br><span class="line">[tuture-add]    ingredients = models.CharField(max_length=<span class="number">400</span>, verbose_name=<span class="string">'食材'</span>)</span><br><span class="line">[tuture-add]    picture = models.FileField(verbose_name=<span class="string">'图片'</span>)</span><br><span class="line">[tuture-add]    difficulty = models.CharField(choices=DIFFICULTY_LEVELS, max_length=<span class="number">10</span>,</span><br><span class="line">[tuture-add]                                  verbose_name=<span class="string">'制作难度'</span>)</span><br><span class="line">[tuture-add]    prep_time = models.PositiveIntegerField(verbose_name=<span class="string">'准备时间'</span>)</span><br><span class="line">[tuture-add]    prep_guide = models.TextField(verbose_name=<span class="string">'制作指南'</span>)</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">[tuture-add]        verbose_name = <span class="string">'食谱'</span></span><br><span class="line">[tuture-add]        verbose_name_plural = <span class="string">'食谱'</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">[tuture-add]        <span class="keyword">return</span> <span class="string">'&#123;&#125; 的食谱'</span>.format(self.name)</span><br></pre></td></tr></table></figure><p>其中，<code>class Meta</code> 定义了 <code>Recipe</code> 的元数据；<code>__str__</code> 方法定义了一个菜谱对象转换为字符串时应该怎样显示。这些设置的作用在打开后台管理系统之后就会很清晰了。想要了解更多关于 Django 数据模型的知识，请参考相关<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRqYW5nb3Byb2plY3QuY29tL3poLWhhbnMvMi4yL3RvcGljcy9kYi9tb2RlbHMv" title="https://docs.djangoproject.com/zh-hans/2.2/topics/db/models/">中文文档<i class="fa fa-external-link"></i></span>。</p><p>第二步，为 <code>core</code> 子应用配置相应的后台管理功能。非常简单，只需注册定义好的 <code>Recipe</code> 模型：</p><figure class="highlight py"><figcaption><span>api/core/admin.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line">[tuture-add]<span class="keyword">from</span> .models <span class="keyword">import</span> Recipe</span><br><span class="line"></span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line">[tuture-add]admin.site.register(Recipe)</span><br></pre></td></tr></table></figure><p>第三步，定义序列化器 serializers.py（脚手架并不会自动创建，需要手动创建）。序列化器是 Django Rest Framework 提供的功能，能够非常方便地将 Django 数据模型序列化成相应的 JSON 数据格式。在这里，我们定义一个 <code>RecipeSerializer</code>，并在 <code>class Meta</code> 中指定对应的数据模型为刚才创建的 <code>Recipe</code>，并选择相应的字段展示：</p><figure class="highlight py"><figcaption><span>api/core/serializers.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Recipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecipeSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Recipe</span><br><span class="line">        fields = (</span><br><span class="line">            <span class="string">'id'</span>, <span class="string">'name'</span>, <span class="string">'ingredients'</span>, <span class="string">'picture'</span>,</span><br><span class="line">            <span class="string">'difficulty'</span>, <span class="string">'prep_time'</span>, <span class="string">'prep_guide'</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p>第四步，实现视图。这里我们采用开挂模式，直接调用 Django Rest Framework 提供的模型视图集（<code>ModelViewset</code>）直接搞定数据模型的增删改查逻辑：</p><figure class="highlight py"><figcaption><span>api/core/views.py</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-<span class="keyword">del</span>]<span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line">[tuture-add]<span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line">[tuture-add]<span class="keyword">from</span> .serializers <span class="keyword">import</span> RecipeSerializer</span><br><span class="line">[tuture-add]<span class="keyword">from</span> .models <span class="keyword">import</span> Recipe</span><br><span class="line"></span><br><span class="line">[tuture-<span class="keyword">del</span>]<span class="comment"># Create your views here.</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="class"><span class="keyword">class</span> <span class="title">RecipeViewSet</span><span class="params">(viewsets.ModelViewSet)</span>:</span></span><br><span class="line">[tuture-add]    serializer_class = RecipeSerializer</span><br><span class="line">[tuture-add]    queryset = Recipe.objects.all()</span><br></pre></td></tr></table></figure><p>只需指定 <code>serializer_class</code>（序列器类）和 <code>queryset</code>（模型查询集），就自动定义好了模型的添加、删除、查询和修改！虽然视图集非常强大，但是如果要实现更加灵活的业务逻辑，那么还是要为每个接口定义单独的视图类才行。</p><p>第五步，实现路由。由于我们上一步使用了视图集，因此只需先调用 <code>DefaultRouter</code> 自动生成相关的路由，然后加入记录路由映射的列表 <code>urlpatterns</code> 中：</p><figure class="highlight py"><figcaption><span>api/core/urls.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> RecipeViewSet</span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'recipes'</span>, RecipeViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, include(router.urls)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><code>router</code> 为我们自动生成以下路由：</p><ul><li><code>/recipes/</code>：创建食谱（POST 方法）或读取食谱列表（GET方法）；</li><li><code>/recipes/{id}</code>：获取单个食谱（GET）、更新单个食谱（PUT）或删除食谱（DELETE）。</li></ul><p>注意：<strong>在 Django 路由定义中不包括 HTTP 方法，具体的 HTTP 方法可以在视图中读取并判断</strong>。</p><p>最后一步，我们将 <code>core</code> 子应用中的路由接入全局路由：</p><figure class="highlight py"><figcaption><span>api/api/urls.py</span></figcaption><table><tr><td class="code"><pre><span class="line">    <span class="number">2.</span> Add a URL to urlpatterns:  path(<span class="string">'blog/'</span>, include(<span class="string">'blog.urls'</span>))</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from django.contrib import admin</span></span><br><span class="line"><span class="string">[tuture-del]from django.urls import path</span></span><br><span class="line"><span class="string">[tuture-add]from django.urls import path, include</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">urlpatterns = [</span></span><br><span class="line"><span class="string">    path('admin/', admin.site.urls),</span></span><br><span class="line"><span class="string">[tuture-add]    path('api/', include('core.urls')),</span></span><br><span class="line"><span class="string">]</span></span><br></pre></td></tr></table></figure><h2 id="用-Nuxt-js-实现网站首页"><a href="#用-Nuxt-js-实现网站首页" class="headerlink" title="用 Nuxt.js 实现网站首页"></a>用 Nuxt.js 实现网站首页</h2><p>服务器实现完毕之后，就轮到 Nuxt 登场了。我们将把所有的前端代码放到 client 目录中，不过无需自己创建，我们调用 nuxt 的脚手架来创建前端应用：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npx create-nuxt-app client</span><br></pre></td></tr></table></figure><p>之后脚手架应用会询问一系列问题，按下面的截图进行选择（当然作者名填自己）：</p><p><img alt data-src="./create-nuxt-app.jpg"></p><p>我们对 Nuxt 脚手架生成的目录结构稍作讲解。可以看到 client 目录下有以下子目录：</p><ul><li>assets：存放图片、CSS、JS 等原始资源文件</li><li>components：存放 Vue 组件</li><li>layouts：存放应用布局文件，布局可在多个页面中使用</li><li>middleware：存放应用的中间件。Nuxt 中的中间件指页面渲染前执行的自定义函数（本教程中不需要）</li><li>pages：应用的视图和路由。Nuxt 会根据此目录中的 <code>.vue</code> 文件自动创建应用的路由</li><li>plugins: 存放 JavaScript 插件，用于在应用启动前加载（本教程中不需要）</li><li>static：存放通常不会改变的静态文件，并且将直接映射到路由（即可通过 <code>/static/picture.png</code> 访问）</li><li>store：存放 Vuex Store 文件（本教程中不需要）</li></ul><p>本项目所用到的图片资源请访问我的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21SY2Zwcy9yZWNpcGVzX2FwcC90cmVlL21hc3Rlci9jbGllbnQvc3RhdGljL2ltYWdlcw==" title="https://github.com/mRcfps/recipes_app/tree/master/client/static/images">GitHub 仓库<i class="fa fa-external-link"></i></span>，并下载到对应的目录中。</p><p>我们在 client/pages 中创建 index.vue 文件，并在其中实现我们的前端首页：</p><figure class="highlight html"><figcaption><span>client/pages/index.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"text-box"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>吃货天堂 😋<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"mt-3"</span>&gt;</span>制作我们喜爱的美食 ❤️ ️<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">class</span>=<span class="string">"btn btn-outline btn-large btn-info"</span> <span class="attr">to</span>=<span class="string">"/recipes"</span>&gt;</span></span><br><span class="line">        查看食谱</span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"ml-2"</span>&gt;</span>&amp;rarr;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">  head() &#123;</span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">      title: <span class="string">"首页"</span></span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">header &#123;</span><br><span class="line">  min-height: 100vh;</span><br><span class="line">  background-image: linear-gradient(</span><br><span class="line">      to right,</span><br><span class="line"><span class="css">      <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.9</span>),</span></span><br><span class="line"><span class="css">      <span class="selector-tag">rgba</span>(12, 5, 5, 0<span class="selector-class">.4</span>)</span></span><br><span class="line">    ),</span><br><span class="line">    url("/images/banner.jpg");</span><br><span class="line">  background-position: center;</span><br><span class="line">  background-size: cover;</span><br><span class="line">  position: relative;</span><br><span class="line">&#125;</span><br><span class="line"><span class="css"><span class="selector-class">.text-box</span> &#123;</span></span><br><span class="line">  position: absolute;</span><br><span class="line">  top: 50%;</span><br><span class="line">  left: 10%;</span><br><span class="line">  transform: translateY(-50%);</span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#fff</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="css"><span class="selector-class">.text-box</span> <span class="selector-tag">h1</span> &#123;</span></span><br><span class="line">  font-family: cursive;</span><br><span class="line">  font-size: 5rem;</span><br><span class="line">&#125;</span><br><span class="line"><span class="css"><span class="selector-class">.text-box</span> <span class="selector-tag">p</span> &#123;</span></span><br><span class="line">  font-size: 2rem;</span><br><span class="line">  font-weight: lighter;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>模板（Template）+ 脚本（Script）+ 样式（Style），经典的 Vue.js 组件。如果对 Vue.js 还不熟悉的话，建议学习巍哥的 Vue 入门系列教材。</p><p>我们刚刚创建了 pages 目录下的 index.vue 文件，这意味着当访问根路由 <code>/</code> 时，这个文件将被访问到。通过 <code>npm run dev</code>运行我们的前端页面（<strong><em>记得在 client 子目录下运行！</em></strong>），可以看到：</p><p><img alt data-src="./index-page.jpg"></p><p>真是让人食欲大开！</p><h2 id="数据展示：实现食谱列表"><a href="#数据展示：实现食谱列表" class="headerlink" title="数据展示：实现食谱列表"></a>数据展示：实现食谱列表</h2><p>接下来我们将演示如何展示数据，并实现食谱列表页面。</p><p>首先，实现将会在多个页面中反复使用的食谱卡片组件 <code>RecipeCard</code> 如下：</p><figure class="highlight html"><figcaption><span>client/components/RecipeCard.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card recipe-card"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"recipe.picture"</span> <span class="attr">class</span>=<span class="string">"card-img-top"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-body"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h5</span> <span class="attr">class</span>=<span class="string">"card-title"</span>&gt;</span>&#123;&#123; recipe.name &#125;&#125;<span class="tag">&lt;/<span class="name">h5</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"card-text"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">strong</span>&gt;</span>成分:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">        &#123;&#123; recipe.ingredients &#125;&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"action-buttons"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">:to</span>=<span class="string">"`/recipes/$&#123;recipe.id&#125;/`"</span> <span class="attr">class</span>=<span class="string">"btn btn-sm btn-success"</span>&gt;</span>查看<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">:to</span>=<span class="string">"`/recipes/$&#123;recipe.id&#125;/edit/`"</span> <span class="attr">class</span>=<span class="string">"btn btn-sm btn-primary"</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"onDelete(recipe.id)"</span> <span class="attr">class</span>=<span class="string">"btn btn-sm btn-danger"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">  props: [<span class="string">"recipe"</span>, <span class="string">"onDelete"</span>]</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-class">.card-img-top</span> &#123;</span></span><br><span class="line">  height: 12rem;</span><br><span class="line">  width: 100%;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="css"><span class="selector-class">.recipe-card</span> &#123;</span></span><br><span class="line">  border: none;</span><br><span class="line"><span class="css">  <span class="selector-tag">box-shadow</span>: 0 1<span class="selector-tag">rem</span> 1<span class="selector-class">.5rem</span> <span class="selector-tag">rgba</span>(0, 0, 0, 0<span class="selector-class">.6</span>);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在这个组件中，我们定义了两个 <code>props</code>，分别是 <code>recipe</code>（代表食谱对象）和 <code>onDelete</code>（删除时的回调函数），并在模板中使用这两个成员。</p><p>接下来我们将深入体验 Nuxt 的路由功能——通过 pages 目录下的文档结构，就可以自动生成 vue-router 的路由器配置！</p><p>例如我们这样安排 pages 下面的目录结构👇：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pages</span><br><span class="line">├── README.md</span><br><span class="line">├── index.vue</span><br><span class="line">└── recipes</span><br><span class="line">    ├── _id</span><br><span class="line">    │   ├── edit.vue</span><br><span class="line">    │   └── index.vue</span><br><span class="line">    ├── add.vue</span><br><span class="line">    └── index.vue</span><br></pre></td></tr></table></figure><p><code>_id</code> 目录（或者其他以单下划线开头的目录或 .vue 文件）被称作是<strong>动态路由</strong>（Dynamic Routing），可以接受参数作为 URL 的一部分。上面的 pages 目录自动生成下面的 <code>router</code>：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router: &#123;</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'index'</span>,</span><br><span class="line">      path: <span class="string">'/'</span>,</span><br><span class="line">      component: <span class="string">'pages/index.vue'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'recipes'</span>,</span><br><span class="line">      path: <span class="string">'/recipes'</span>,</span><br><span class="line">      component: <span class="string">'pages/recipes/index.vue'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'recipes-add'</span>,</span><br><span class="line">      path: <span class="string">'/recipes/add'</span>,</span><br><span class="line">      component: <span class="string">'pages/recipes/add.vue'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'recipes-id'</span>,</span><br><span class="line">      path: <span class="string">'/recipes/:id?'</span>,</span><br><span class="line">      component: <span class="string">'pages/recipes/_id/index.vue'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'recipes-id-edit'</span>,</span><br><span class="line">      path: <span class="string">'/recipes/:id?/edit'</span>,</span><br><span class="line">      component: <span class="string">'pages/recipes/_id/edit.vue'</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果想要更深入地了解 Nuxt 的路由功能，请参考<span class="exturl" data-url="aHR0cHM6Ly9udXh0anMub3JnL2d1aWRlL3JvdXRpbmc=" title="https://nuxtjs.org/guide/routing">官方文档<i class="fa fa-external-link"></i></span>。</p><p>创建食谱列表页面 pages/recipes/index.vue（先使用假数据填充），代码如下：</p><figure class="highlight html"><figcaption><span>client/pages/recipes/index.vue</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">"container mt-5"</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-12 text-right mb-4"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"d-flex justify-content-between"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">h3</span>&gt;</span>吃货天堂<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">nuxt-link</span> <span class="attr">to</span>=<span class="string">"/recipes/add"</span> <span class="attr">class</span>=<span class="string">"btn btn-info"</span>&gt;</span>添加食谱<span class="tag">&lt;/<span class="name">nuxt-link</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">"recipe in recipes"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">:key</span>=<span class="string">"recipe.id"</span> <span class="attr">class</span>=<span class="string">"col-lg-3 col-md-4 col-sm-6 mb-4"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">recipe-card</span> <span class="attr">:onDelete</span>=<span class="string">"deleteRecipe"</span> <span class="attr">:recipe</span>=<span class="string">"recipe"</span>&gt;</span><span class="tag">&lt;/<span class="name">recipe-card</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">[tuture-add]<span class="keyword">import</span> RecipeCard <span class="keyword">from</span> <span class="string">"~/components/RecipeCard.vue"</span>;</span></span><br><span class="line">[tuture-add]</span><br><span class="line"><span class="actionscript">[tuture-add]<span class="keyword">const</span> sampleData = [</span></span><br><span class="line">[tuture-add]  &#123;</span><br><span class="line">[tuture-add]    id: 1,</span><br><span class="line"><span class="actionscript">[tuture-add]    name: <span class="string">"通心粉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    picture: <span class="string">"/images/food-1.jpeg"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    ingredients: <span class="string">"牛肉, 猪肉, 羊肉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    difficulty: <span class="string">"easy"</span>,</span></span><br><span class="line">[tuture-add]    prep_time: 15,</span><br><span class="line">[tuture-add]    prep_guide:</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="string">"Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis, porro. Dignissimos ducimus ratione totam fugit officiis blanditiis exercitationem, nisi vero architecto quibusdam impedit, earum "</span></span></span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  &#123;</span><br><span class="line">[tuture-add]    id: 2,</span><br><span class="line"><span class="actionscript">[tuture-add]    name: <span class="string">"羊肉串"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    picture: <span class="string">"/images/food-2.jpeg"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    ingredients: <span class="string">"牛肉, 猪肉, 羊肉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    difficulty: <span class="string">"easy"</span>,</span></span><br><span class="line">[tuture-add]    prep_time: 15,</span><br><span class="line">[tuture-add]    prep_guide:</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="string">"Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis, porro. Dignissimos ducimus ratione totam fugit officiis blanditiis exercitationem, nisi vero architecto quibusdam impedit, earum "</span></span></span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  &#123;</span><br><span class="line">[tuture-add]    id: 3,</span><br><span class="line"><span class="actionscript">[tuture-add]    name: <span class="string">"炒饭"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    picture: <span class="string">"/images/banner.jpg"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    ingredients: <span class="string">"牛肉, 猪肉, 羊肉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]    difficulty: <span class="string">"easy"</span>,</span></span><br><span class="line">[tuture-add]    prep_time: 15,</span><br><span class="line">[tuture-add]    prep_guide:</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="string">"Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis, porro. Dignissimos ducimus ratione totam fugit officiis blanditiis exercitationem, nisi vero architecto quibusdam impedit, earum "</span></span></span><br><span class="line">[tuture-add]  &#125;</span><br><span class="line">[tuture-add]];</span><br><span class="line">[tuture-add]</span><br><span class="line"><span class="javascript">[tuture-add]<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">[tuture-add]  head() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      title: <span class="string">"食谱列表"</span></span></span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  components: &#123;</span><br><span class="line">[tuture-add]    RecipeCard</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  asyncData(context) &#123;</span><br><span class="line"><span class="javascript">[tuture-add]    <span class="keyword">let</span> data = sampleData;</span></span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-add]      recipes: data</span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  data() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-add]      recipes: []</span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  methods: &#123;</span><br><span class="line">[tuture-add]    deleteRecipe(recipe_id) &#123;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="built_in">console</span>.log(deleted<span class="string">`<span class="subst">$&#123;recipe.id&#125;</span>`</span>);</span></span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">[tuture-add]  &#125;</span><br><span class="line">[tuture-add]&#125;;</span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-attr">[tuture-add]</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>打开前端网站，可以看到我们刚才实现的食谱列表页面：</p><p><img alt data-src="./recipe-list-fake.jpg"></p><h2 id="从服务器获取数据"><a href="#从服务器获取数据" class="headerlink" title="从服务器获取数据"></a>从服务器获取数据</h2><p>在这一步中，我们将打通前后端——前端将从后端获取数据。</p><p>首先我们要配置一下 Django 服务器，使前端能够访问其静态文件。调整 api/api/urls 文件如下：</p><figure class="highlight py"><figcaption><span>api/api/urls.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">from django.contrib import admin</span></span><br><span class="line"><span class="string">from django.urls import path, include</span></span><br><span class="line"><span class="string">[tuture-add]from django.conf import settings</span></span><br><span class="line"><span class="string">[tuture-add]from django.conf.urls.static import static</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">urlpatterns = [</span></span><br><span class="line"><span class="string">    path('admin/', admin.site.urls),</span></span><br><span class="line"><span class="string">    path('api/', include('core.urls')),</span></span><br><span class="line"><span class="string">[tuture-del]]</span></span><br><span class="line"><span class="string">[tuture-add]] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span></span><br></pre></td></tr></table></figure><p>需要注意的是，这样配置静态文件路由仅应当在开发环境下使用。在生产环境下（settings.py 中的 <code>DEBUG</code> 设为 <code>False</code> 时），静态文件路由将自动生效（因为 Django 并不适合作为静态文件服务器，应该选用类似 Nginx 之类的服务器，在后续教程中我们将更深入地讨论）。</p><p>在客户端，我们先要对 Nuxt 进行全局配置。Nuxt 包括 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2F4aW9zL2F4aW9z" title="https://github.com/axios/axios">axios<i class="fa fa-external-link"></i></span> 包，这是一个非常出色的基于 Promise 的 HTTP 请求库。在 nuxt.config.js 中的 <code>axios</code> 一项中添加 Django 服务器的 URL：</p><figure class="highlight js"><figcaption><span>client/nuxt.config.js</span></figcaption><table><tr><td class="code"><pre><span class="line">  ** See https:<span class="comment">//axios.nuxtjs.org/options</span></span><br><span class="line">  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">  axios: &#123;</span></span><br><span class="line"><span class="regexp">[tuture-add]    baseURL: 'http:/</span><span class="regexp">/localhost:8000/</span>api<span class="string">',</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  /*</span></span><br><span class="line"><span class="string">  ** Build configuration</span></span><br></pre></td></tr></table></figure><p>将食谱列表页面中暂时填充的假数据删去，通过 <code>asyncData</code> 方法获取数据。由于我们之前配置好了 axios，所以 <code>asyncData</code> 函数可以获取到 <code>$axios</code> 对象用于发起 HTTP 请求。我们实现页面加载的数据获取以及 <code>deleteRecipe</code> 事件，代码如下：</p><figure class="highlight html"><figcaption><span>client/pages/recipes/index.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> RecipeCard <span class="keyword">from</span> <span class="string">"~/components/RecipeCard.vue"</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">[tuture-del]<span class="keyword">const</span> sampleData = [</span></span><br><span class="line">[tuture-del]  &#123;</span><br><span class="line">[tuture-del]    id: 1,</span><br><span class="line"><span class="actionscript">[tuture-del]    name: <span class="string">"通心粉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    picture: <span class="string">"/images/food-1.jpeg"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    ingredients: <span class="string">"牛肉, 猪肉, 羊肉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    difficulty: <span class="string">"easy"</span>,</span></span><br><span class="line">[tuture-del]    prep_time: 15,</span><br><span class="line">[tuture-del]    prep_guide:</span><br><span class="line"><span class="actionscript">[tuture-del]      <span class="string">"Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis, porro. Dignissimos ducimus ratione totam fugit officiis blanditiis exercitationem, nisi vero architecto quibusdam impedit, earum "</span></span></span><br><span class="line">[tuture-del]  &#125;,</span><br><span class="line">[tuture-del]  &#123;</span><br><span class="line">[tuture-del]    id: 2,</span><br><span class="line"><span class="actionscript">[tuture-del]    name: <span class="string">"羊肉串"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    picture: <span class="string">"/images/food-2.jpeg"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    ingredients: <span class="string">"牛肉, 猪肉, 羊肉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    difficulty: <span class="string">"easy"</span>,</span></span><br><span class="line">[tuture-del]    prep_time: 15,</span><br><span class="line">[tuture-del]    prep_guide:</span><br><span class="line"><span class="actionscript">[tuture-del]      <span class="string">"Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis, porro. Dignissimos ducimus ratione totam fugit officiis blanditiis exercitationem, nisi vero architecto quibusdam impedit, earum "</span></span></span><br><span class="line">[tuture-del]  &#125;,</span><br><span class="line">[tuture-del]  &#123;</span><br><span class="line">[tuture-del]    id: 3,</span><br><span class="line"><span class="actionscript">[tuture-del]    name: <span class="string">"炒饭"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    picture: <span class="string">"/images/banner.jpg"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    ingredients: <span class="string">"牛肉, 猪肉, 羊肉"</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-del]    difficulty: <span class="string">"easy"</span>,</span></span><br><span class="line">[tuture-del]    prep_time: 15,</span><br><span class="line">[tuture-del]    prep_guide:</span><br><span class="line"><span class="actionscript">[tuture-del]      <span class="string">"Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis, porro. Dignissimos ducimus ratione totam fugit officiis blanditiis exercitationem, nisi vero architecto quibusdam impedit, earum "</span></span></span><br><span class="line">[tuture-del]  &#125;</span><br><span class="line">[tuture-del]];</span><br><span class="line">[tuture-del]</span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">  head() &#123;</span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-omit]</span><br><span class="line">  components: &#123;</span><br><span class="line">    RecipeCard</span><br><span class="line">  &#125;,</span><br><span class="line">[tuture-del]  asyncData(context) &#123;</span><br><span class="line"><span class="javascript">[tuture-del]    <span class="keyword">let</span> data = sampleData;</span></span><br><span class="line"><span class="actionscript">[tuture-del]    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-del]      recipes: data</span><br><span class="line">[tuture-del]    &#125;;</span><br><span class="line"><span class="javascript">[tuture-add]  <span class="keyword">async</span> asyncData(&#123; $axios, params &#125;) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> recipes = <span class="keyword">await</span> $axios.$<span class="keyword">get</span>(`/recipes/`);</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">return</span> &#123; recipes &#125;;</span></span><br><span class="line"><span class="actionscript">[tuture-add]    &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">return</span> &#123; recipes: [] &#125;;</span></span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-omit]</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">[tuture-del]    deleteRecipe(recipe_id) &#123;</span><br><span class="line"><span class="javascript">[tuture-del]      <span class="built_in">console</span>.log(deleted<span class="string">`<span class="subst">$&#123;recipe.id&#125;</span>`</span>);</span></span><br><span class="line"><span class="javascript">[tuture-add]    <span class="keyword">async</span> deleteRecipe(recipe_id) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        <span class="keyword">if</span> (confirm(<span class="string">'确认要删除吗？'</span>)) &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]          <span class="keyword">await</span> <span class="keyword">this</span>.$axios.$<span class="keyword">delete</span>(<span class="string">`/recipes/<span class="subst">$&#123;recipe_id&#125;</span>/`</span>);</span></span><br><span class="line"><span class="javascript">[tuture-add]          <span class="keyword">let</span> newRecipes = <span class="keyword">await</span> <span class="keyword">this</span>.$axios.$<span class="keyword">get</span>("/recipes/");</span></span><br><span class="line"><span class="actionscript">[tuture-add]          <span class="keyword">this</span>.recipes = newRecipes;</span></span><br><span class="line">[tuture-add]        &#125;</span><br><span class="line"><span class="actionscript">[tuture-add]      &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]        <span class="built_in">console</span>.log(e);</span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我们进一步实现食谱详情页面。在 pages/recipes 目录中创建 _id 目录，在其中添加 index.vue 文件，代码如下：</p><figure class="highlight html"><figcaption><span>client/pages/recipes/_id/index.vue</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">"container my-5"</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-12 text-center my-3"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"mb-3 display-4 text-uppercase"</span>&gt;</span>&#123;&#123; recipe.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 mb-4"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">class</span>=<span class="string">"img-fluid"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">style</span>=<span class="string">"width: 400px; border-radius: 10px; box-shadow: 0 1rem 1rem rgba(0,0,0,.7);"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">:src</span>=<span class="string">"recipe.picture"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">alt</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]        &gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"recipe-details"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">h4</span>&gt;</span>食材<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; recipe.ingredients &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">h4</span>&gt;</span>准备时间 ⏱<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; recipe.prep_time &#125;&#125; mins<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">h4</span>&gt;</span>制作难度<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; recipe.difficulty &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">h4</span>&gt;</span>制作指南<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">rows</span>=<span class="string">"10"</span> <span class="attr">v-html</span>=<span class="string">"recipe.prep_guide"</span> <span class="attr">disabled</span>/&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">[tuture-add]<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">[tuture-add]  head() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      title: <span class="string">"食谱详情"</span></span></span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line"><span class="javascript">[tuture-add]  <span class="keyword">async</span> asyncData(&#123; $axios, params &#125;) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> recipe = <span class="keyword">await</span> $axios.$<span class="keyword">get</span>(`/recipes/$&#123;params.id&#125;<span class="string">`);</span></span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">return</span> &#123; recipe &#125;;</span></span><br><span class="line"><span class="actionscript">[tuture-add]    &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">return</span> &#123; recipe: [] &#125;;</span></span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  data() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-add]      recipe: &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]        name: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        picture: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        ingredients: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        difficulty: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        prep_time: <span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        prep_guide: <span class="string">""</span></span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;</span><br><span class="line">[tuture-add]&#125;;</span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-attr">[tuture-add]</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>为了测试前端页面能否真正从后端获取数据，我们先要在后端数据库中添加一些数据，而这对 Django 来说就非常方便了。进入 api 目录，运行 <code>python manage.py runserver</code> 打开服务器，然后进入后台管理页面（<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDAwL2FkbWlu" title="http://localhost:8000/admin">http://localhost:8000/admin<i class="fa fa-external-link"></i></span>），添加一些数据：</p><p><img alt data-src="./add-data-in-admin.jpg"></p><p>再运行前端页面，可以看到我们刚刚在 Django 后台管理中添加的项目：</p><p><img alt data-src="./recipe-list.jpg"></p><h2 id="实现食谱的详情和添加页面"><a href="#实现食谱的详情和添加页面" class="headerlink" title="实现食谱的详情和添加页面"></a>实现食谱的详情和添加页面</h2><p>有了前面的铺垫，实现食谱的添加和删除也基本上是按部就班了。我们在 pages/recipes/_id 中分别实现 <code>edit.vue</code>（食谱详情页面） 和 <code>add.vue</code> （创建食谱页面）如下。</p><figure class="highlight html"><figcaption><span>client/pages/recipes/_id/edit.vue</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">"container my-5"</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-12 text-center my-3"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"mb-3 display-4 text-uppercase"</span>&gt;</span>&#123;&#123; recipe.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 mb-4"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">img</span> <span class="attr">v-if</span>=<span class="string">"!preview"</span> <span class="attr">class</span>=<span class="string">"img-fluid"</span> <span class="attr">style</span>=<span class="string">"width: 400px; border-radius: 10px; box-shadow: 0 1rem 1rem rgba(0,0,0,.7);"</span>  <span class="attr">:src</span>=<span class="string">"recipe.picture"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">img</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">"img-fluid"</span> <span class="attr">style</span>=<span class="string">"width: 400px; border-radius: 10px; box-shadow: 0 1rem 1rem rgba(0,0,0,.7);"</span>  <span class="attr">:src</span>=<span class="string">"preview"</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">form</span> @<span class="attr">submit.prevent</span>=<span class="string">"submitRecipe"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>Recipe Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">v-model</span>=<span class="string">"recipe.name"</span> &gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>Ingredients<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"recipe.ingredients"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"Ingredients"</span> &gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>Food picture<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> @<span class="attr">change</span>=<span class="string">"onFileChange"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>Difficulty<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">select</span> <span class="attr">v-model</span>=<span class="string">"recipe.difficulty"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> &gt;</span></span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Easy"</span>&gt;</span>Easy<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Medium"</span>&gt;</span>Medium<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Hard"</span>&gt;</span>Hard<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span></span><br><span class="line">[tuture-add]                  Prep time</span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">small</span>&gt;</span>(minutes)<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"recipe.prep_time"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"Ingredients"</span> &gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group mb-3"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>Preparation guide<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">v-model</span>=<span class="string">"recipe.prep_guide"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">rows</span>=<span class="string">"8"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span>&gt;</span>Save<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">[tuture-add]<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">[tuture-add]  head()&#123;</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        title: <span class="string">"编辑食谱"</span></span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line"><span class="javascript">[tuture-add]  <span class="keyword">async</span> asyncData(&#123; $axios, params &#125;) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> recipe = <span class="keyword">await</span> $axios.$<span class="keyword">get</span>(`/recipes/$&#123;params.id&#125;<span class="string">`);</span></span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">return</span> &#123; recipe &#125;;</span></span><br><span class="line"><span class="actionscript">[tuture-add]    &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">return</span> &#123; recipe: [] &#125;;</span></span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  data() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-add]      recipe: &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]        name: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        picture: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        ingredients: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        difficulty: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        prep_time: <span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        prep_guide: <span class="string">""</span></span></span><br><span class="line">[tuture-add]      &#125;,</span><br><span class="line"><span class="actionscript">[tuture-add]      preview: <span class="string">""</span></span></span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  methods: &#123;</span><br><span class="line">[tuture-add]    onFileChange(e) &#123;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> files = e.target.files || e.dataTransfer.files;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">if</span> (!files.length) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        <span class="keyword">return</span>;</span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">this</span>.recipe.picture = files[<span class="number">0</span>]</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">this</span>.createImage(files[<span class="number">0</span>]);</span></span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line">[tuture-add]    createImage(file) &#123;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> vm = <span class="keyword">this</span>;</span></span><br><span class="line"><span class="javascript">[tuture-add]      reader.onload = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span></span><br><span class="line">[tuture-add]        vm.preview = e.target.result;</span><br><span class="line">[tuture-add]      &#125;;</span><br><span class="line">[tuture-add]      reader.readAsDataURL(file);</span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line"><span class="javascript">[tuture-add]    <span class="keyword">async</span> submitRecipe() &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> editedRecipe = <span class="keyword">this</span>.recipe</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">if</span> (editedRecipe.picture.indexOf(<span class="string">"http://"</span>) != <span class="number">-1</span>)&#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        <span class="keyword">delete</span> editedRecipe[<span class="string">"picture"</span>]</span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">const</span> config = &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        headers: &#123; <span class="string">"content-type"</span>: <span class="string">"multipart/form-data"</span> &#125;</span></span><br><span class="line">[tuture-add]      &#125;;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> formData = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">for</span> (<span class="keyword">let</span> data <span class="keyword">in</span> editedRecipe) &#123;</span></span><br><span class="line">[tuture-add]        formData.append(data, editedRecipe[data]);</span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]        <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="keyword">this</span>.$axios.$patch(<span class="string">`/recipes/<span class="subst">$&#123;editedRecipe.id&#125;</span>/`</span>, formData, config);</span></span><br><span class="line"><span class="actionscript">[tuture-add]        <span class="keyword">this</span>.$router.push(<span class="string">"/recipes/"</span>);</span></span><br><span class="line"><span class="actionscript">[tuture-add]      &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]        <span class="built_in">console</span>.log(e);</span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">[tuture-add]  &#125;</span><br><span class="line">[tuture-add]&#125;;</span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-attr">[tuture-add]</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>实现之后的页面如下：</p><p><img alt data-src="./recipe-detail.jpg"></p><figure class="highlight html"><figcaption><span>client/pages/recipes/add.vue</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">"container my-5"</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-12 text-center my-3"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"mb-3 display-4 text-uppercase"</span>&gt;</span>&#123;&#123; recipe.name &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 mb-4"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">v-if</span>=<span class="string">"preview"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">class</span>=<span class="string">"img-fluid"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">style</span>=<span class="string">"width: 400px; border-radius: 10px; box-shadow: 0 1rem 1rem rgba(0,0,0,.7);"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">:src</span>=<span class="string">"preview"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">alt</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]        &gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">v-else</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">class</span>=<span class="string">"img-fluid"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">style</span>=<span class="string">"width: 400px; border-radius: 10px; box-shadow: 0 1rem 1rem rgba(0,0,0,.7);"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]          <span class="attr">src</span>=<span class="string">"@/static/images/placeholder.png"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]        &gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">form</span> @<span class="attr">submit.prevent</span>=<span class="string">"submitRecipe"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>食谱名称<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">v-model</span>=<span class="string">"recipe.name"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>食材<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">"recipe.ingredients"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>图片<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> @<span class="attr">change</span>=<span class="string">"onFileChange"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>难度<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">select</span> <span class="attr">v-model</span>=<span class="string">"recipe.difficulty"</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Easy"</span>&gt;</span>容易<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Medium"</span>&gt;</span>中等<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"Hard"</span>&gt;</span>困难<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span></span><br><span class="line">[tuture-add]                  制作时间</span><br><span class="line">[tuture-add]                  <span class="tag">&lt;<span class="name">small</span>&gt;</span>(分钟)<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]                <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">"recipe.prep_time"</span> <span class="attr">type</span>=<span class="string">"number"</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">[tuture-add]              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group mb-3"</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>&gt;</span>制作指南<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">v-model</span>=<span class="string">"recipe.prep_guide"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">rows</span>=<span class="string">"8"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">[tuture-add]<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">[tuture-add]  head() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      title: <span class="string">"Add Recipe"</span></span></span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  data() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-add]      recipe: &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]        name: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        picture: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        ingredients: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        difficulty: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        prep_time: <span class="literal">null</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]        prep_guide: <span class="string">""</span></span></span><br><span class="line">[tuture-add]      &#125;,</span><br><span class="line"><span class="actionscript">[tuture-add]      preview: <span class="string">""</span></span></span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  methods: &#123;</span><br><span class="line">[tuture-add]    onFileChange(e) &#123;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> files = e.target.files || e.dataTransfer.files;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">if</span> (!files.length) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        <span class="keyword">return</span>;</span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">this</span>.recipe.picture = files[<span class="number">0</span>];</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">this</span>.createImage(files[<span class="number">0</span>]);</span></span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line">[tuture-add]    createImage(file) &#123;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> reader = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> vm = <span class="keyword">this</span>;</span></span><br><span class="line"><span class="javascript">[tuture-add]      reader.onload = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span></span><br><span class="line">[tuture-add]        vm.preview = e.target.result;</span><br><span class="line">[tuture-add]      &#125;;</span><br><span class="line">[tuture-add]      reader.readAsDataURL(file);</span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line"><span class="javascript">[tuture-add]    <span class="keyword">async</span> submitRecipe() &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">const</span> config = &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        headers: &#123; <span class="string">"content-type"</span>: <span class="string">"multipart/form-data"</span> &#125;</span></span><br><span class="line">[tuture-add]      &#125;;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">let</span> formData = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">[tuture-add]      <span class="keyword">for</span> (<span class="keyword">let</span> data <span class="keyword">in</span> <span class="keyword">this</span>.recipe) &#123;</span></span><br><span class="line"><span class="actionscript">[tuture-add]        formData.append(data, <span class="keyword">this</span>.recipe[data]);</span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line"><span class="actionscript">[tuture-add]      <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]        <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="keyword">this</span>.$axios.$post(<span class="string">"/recipes/"</span>, formData, config);</span></span><br><span class="line"><span class="actionscript">[tuture-add]        <span class="keyword">this</span>.$router.push(<span class="string">"/recipes/"</span>);</span></span><br><span class="line"><span class="actionscript">[tuture-add]      &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="javascript">[tuture-add]        <span class="built_in">console</span>.log(e);</span></span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">[tuture-add]  &#125;</span><br><span class="line">[tuture-add]&#125;;</span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-attr">[tuture-add]</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>实现的页面如下：</p><p><img alt data-src="./add-recipe.jpg"></p><h2 id="一点强迫症：全局页面跳转效果"><a href="#一点强迫症：全局页面跳转效果" class="headerlink" title="一点强迫症：全局页面跳转效果"></a>一点强迫症：全局页面跳转效果</h2><p>在这一节中，我们将演示如何在 Nuxt 中添加全局样式文件，来实现前端页面之间的跳转效果。</p><p>首先在 assets 目录中创建 css 目录，并在其中添加 transition.css 文件，代码如下：</p><figure class="highlight css"><figcaption><span>client/assets/css/transition.css</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.page-enter-active</span>,</span><br><span class="line"><span class="selector-class">.page-leave-active</span> &#123;</span><br><span class="line">  <span class="attribute">transition</span>: opacity .<span class="number">3s</span> ease;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.page-enter</span>,</span><br><span class="line"><span class="selector-class">.page-leave-to</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 Nuxt 配置文件中将刚才写的 transition.css 中添加到全局 CSS 中：</p><figure class="highlight js"><figcaption><span>client/nuxt.config.js</span></figcaption><table><tr><td class="code"><pre><span class="line">  ** Global CSS</span><br><span class="line">  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">  css: [</span></span><br><span class="line"><span class="regexp">[tuture-add]    '~/</span>assets/css/transition.css<span class="string">',</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  /*</span></span><br><span class="line"><span class="string">  ** Plugins to load before mounting the App</span></span><br></pre></td></tr></table></figure><p>至此，一个具有完整增删改查功能、实现了的前后端分离的食谱网站就完成了！</p>]]></content>
    
    <summary type="html">
    
      Django 作为 Python 社区最受欢迎的 Web 框架之一，凭借其高度抽象的组件和强大方便的脚手架，将快速且流畅的开发体验演绎到了极致。而 Nuxt 作为从 Vue.js 进化而来的前端框架，能够轻松胜任复杂的 SPA（单页应用）开发。两者相遇，能够擦出怎样的火花？这篇教程将用 Django + Nuxt 实现带有完整的增删改查（CRUD）功能的前后端应用。最后郑重警告：不要在深夜阅读此教程！！！
    
    </summary>
    
    
    
      <category term="Vue" scheme="https://tuture.co/tags/Vue/"/>
    
      <category term="Django" scheme="https://tuture.co/tags/Django/"/>
    
  </entry>
  
  <entry>
    <title>使用 Vue 和 Node 开发一个迷你淘宝(一)</title>
    <link href="https://tuture.co/2019/10/17/0b662ce/"/>
    <id>https://tuture.co/2019/10/17/0b662ce/</id>
    <published>2019-10-17T00:00:00.509Z</published>
    <updated>2019-10-20T08:52:55.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>Vue 是<span class="exturl" data-url="aHR0cHM6Ly9ldmFueW91Lm1lLw==" title="https://evanyou.me/">尤雨溪<i class="fa fa-external-link"></i></span> 在2014年创建的一个前端框架，目前 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZQ==" title="https://github.com/vuejs/vue">Github<i class="fa fa-external-link"></i></span> Star 数高达150K，是 Star 数最高的前端项目，并且 Vue 有着极为活跃的社区生态以及专职团队进行维护以确保项目可以健康长久的发展。</p><a id="more"></a><p>目前中国很多互联网公司前端程序员的招聘要求都要求程序员掌握 Vue，像滴滴、美团、饿了么等大厂也在重度使用 Vue 进行开发，并且有着像 <span class="exturl" data-url="aHR0cHM6Ly9lbGVtZW50LmVsZW1lLmNuLyMvemgtQ04=" title="https://element.eleme.cn/#/zh-CN">Element<i class="fa fa-external-link"></i></span> 、<span class="exturl" data-url="aHR0cDovL21wdnVlLmNvbS8=" title="http://mpvue.com/">mpvue<i class="fa fa-external-link"></i></span>、<span class="exturl" data-url="aHR0cDovL2l2aWV3LnRhbGtpbmdkYXRhLmNvbS8jLw==" title="http://iview.talkingdata.com/#/">iView<i class="fa fa-external-link"></i></span> 这样优秀的基于 Vue 开源项目存在，所以学习 Vue 是一个不错的投资，当你学会 Vue，就可以快速开发项目，这样不仅可以接外包挣外快，而且当有了一定的项目经验，还可以在一线互联网大厂找到一份不错的工作。</p><p>看到这里你心动了嘛？心动不如行动！而最幸运的是，本教程将会一步一步带你以实战的方式实现一个 real-life （真实世界中的运行的）项目，并在实战的过程中，了解 Vue 的全貌，现在就打开电脑，跟随者我的脚步，这一次彻底掌握 Vue 开发！</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>你可以在 Github 查看完整的源码。1）<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BmdG9tL3Z1ZS1vbmxpbmUtc2hvcC1mcm9udGVuZA==" title="https://github.com/pftom/vue-online-shop-frontend">前端<i class="fa fa-external-link"></i></span> 2）<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BmdG9tL3Z1ZS1vbmxpbmUtc2hvcC1iYWNrZW5k" title="https://github.com/pftom/vue-online-shop-backend">后端<i class="fa fa-external-link"></i></span></p><h3 id="项目准备"><a href="#项目准备" class="headerlink" title="项目准备"></a>项目准备</h3><h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><p>安装 Node.js，你可以去 <span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnL2VuLw==" title="https://nodejs.org/en/">Node.js<i class="fa fa-external-link"></i></span> 官网下载安装包，Node.js 是跨平台的，所以不用担心你的电脑无法使用。</p><p>通过 Node.js 安装包安装，会同时安装 Node.js 包管理工具 Npm，用于便捷的管理项目依赖和下载第三方包。</p><p>打开终端，输入如下命令测试是否安装成功：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node -v <span class="comment"># v10.16.0</span></span><br><span class="line">npm -v <span class="comment"># 6.9.0</span></span><br></pre></td></tr></table></figure><p>如果在你的终端有如上输出，那么代表你安装成功。</p><blockquote><p>提示：通过上面安装包安装，你会安装最新的 Node 稳定版本，这可能和我的机器上的 Node 版本不一致，但是不用担心，本教程使用到的代码语法适用于绝大多数新的或更老的 Node。</p></blockquote><p>安装 vue-cli，在绝大多数场景下，我们使用 vue-cli 来初始化我们的 vue 项目，本教程也不例外，在终端运行如下命令来安装：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install -g vue-cli</span><br></pre></td></tr></table></figure><p>打开终端，输入如下命令测试是否安装成功：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vue --version <span class="comment"># 2.9.6</span></span><br></pre></td></tr></table></figure><blockquote><p>官方的 cli 工具已经纳入到 @vue/cli 之下，这里我们使用的是相对较老的版本，但是原理基本类似，不影响我们学习 Vue 的开发。</p></blockquote><p>上面两个安装步骤已经足够完成我们的教程的学习，但是我想额外推荐你一款编辑器，VSCode，你可以通过访问 <span class="exturl" data-url="aHR0cHM6Ly9jb2RlLnZpc3VhbHN0dWRpby5jb20v" title="https://code.visualstudio.com/">VSCode<i class="fa fa-external-link"></i></span> 官网安装。</p><p>在 VSCode 里面找到 Vue 插件，可以获得代码语法高亮以及自动格式化非常便捷的功能，并且 VSCode 天然对 JavaScript 的支持，会大大提高我们的开发效率，本教程所涉及项目的开发都是使用 VSCode 完成的。</p><h4 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h4><p>打开终端输入如下命令初始化我们的 Vue 项目：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vue init webpack vue-online-shop-frontend</span><br></pre></td></tr></table></figure><blockquote><p>运行上面的命令之后，会出现一系列选项，在初学阶段我们没有必要理会这些选项，你大可以一路回车，快速完成项目的初始化。</p></blockquote><p>当项目初始化成功之后，接下来通过如下命令开启项目：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># code vue-online-shop-frontend # 如果你使用了 VSCode 编辑器，可以用这行命令打开项目</span></span><br><span class="line"><span class="built_in">cd</span> vue-online-shop-frontend &amp;&amp; npm start</span><br></pre></td></tr></table></figure><p>接着打开浏览器，输入 <code>http://localhost:8080/</code> 查看我们初始好的项目效果。</p><blockquote><p>注意：如果你使用 VSCode 编辑器打开项目进行开发，在运行 <code>code project-name</code> 之前需要安装 <code>code</code> 脚本，具体我找了一篇教程：<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vWmhhbmdjc2MvcC8xMTM2Mjk4Ny5odG1s" title="https://www.cnblogs.com/Zhangcsc/p/11362987.html">https://www.cnblogs.com/Zhangcsc/p/11362987.html<i class="fa fa-external-link"></i></span></p></blockquote><p><img alt="初始化项目效果" data-src="././c5019a89d14f9f9118f22b61136c02c3"></p><h3 id="初探初始化代码"><a href="#初探初始化代码" class="headerlink" title="初探初始化代码"></a>初探初始化代码</h3><p>通过 vue-cli 初始化的项目代码中，我们在整个教程中需要了解的就是以下五个文件：</p><ul><li><code>src/main.js</code></li><li><code>index.html</code></li><li><code>src/App.vue</code></li><li><code>src/router/index.js</code></li><li><code>src/components/HelloWorld.vue</code></li></ul><p>首先我们来看一下 <code>src/main.js</code>，这个是 Vue 编译代码的入口，我们通过导入 <code>Vue</code> 类，<code>App</code> 组件，<code>router</code> 路由，再加上 <code>el</code> ，将这些参数传给 <code>Vue</code> 类，生成 Vue 实例。</p><figure class="highlight js"><figcaption><span>src/main.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">// The Vue build version to load with the `import` command</span></span><br><span class="line"><span class="comment">// (runtime-only or standalone) has been set in webpack.base.conf with an alias.</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span>;</span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">'./router'</span>;</span><br><span class="line"></span><br><span class="line">Vue.config.productionTip = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* eslint-disable no-new */</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  router,</span><br><span class="line">  components: &#123; App &#125;,</span><br><span class="line">  template: <span class="string">'&lt;App/&gt;'</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>接着我们来看一下 <code>index.html</code> 文件，当我们开启项目之后，Vue 使用的编译工具 Webpack 将会根据入口文件 <code>src/main.js</code> 里面声明的 <code>el</code> 属性，找到 <code>index.html</code> 下面 <code>el = &#39;app&#39;</code> 的 DOM 节点，并把编译好的视图模板代码挂载到这个 DOM 节点下面，同时将项目涉及的 JavaScript 和 CSS 代码以 <code>script</code> 和 <code>link</code> 的方式插入到 <code>index.html</code> 中，最后打开  <code>index.html</code> ，我们就可以在浏览器中看到基于 Vue 编写好的前端项目。</p><figure class="highlight html"><figcaption><span>index.html</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>vue-online-shop<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- built files will be auto injected --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>src/App.vue</code> 就是 Vue 为我们提供的组件文件，使得我们可以以一个个组件来组织代码，并通过组件的组合来构建任意规模的项目。</p><p>一般比较小的组件会包含三个部分：</p><ul><li><code>template</code></li><li><code>script</code></li><li><code>style</code></li></ul><p>其实就是对应了传统 Web 三剑客，<code>HTML</code>、<code>JavaScript</code>、<code>CSS</code>。</p><p>这里在 <code>template</code> 部分展示了一张 Vue 的 logo 图片，然后显示此刻渲染的路由组件：<code>&lt;router-view /&gt;</code>。我们将在后面继续讲解路由，所以这里不懂没有关系。</p><p><code>script</code> 部分，主要是导出了一个名为 <code>App</code> 的组件。</p><p><code>style</code> 部分就是我们熟悉的 CSS 代码了。</p><figure class="highlight html"><figcaption><span>src/App.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"./assets/logo.png"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">  name: <span class="string">'App'</span>,</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css"><span class="selector-id">#app</span> &#123;</span></span><br><span class="line">  font-family: 'Avenir', Helvetica, Arial, sans-serif;</span><br><span class="line">  -webkit-font-smoothing: antialiased;</span><br><span class="line">  -moz-osx-font-smoothing: grayscale;</span><br><span class="line">  text-align: center;</span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#2c3e50</span>;</span></span><br><span class="line">  margin-top: 60px;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面这个是一般比较小的组件的写法，当组件中涉及的代码较多时，我们需要把 <code>script</code> 和 <code>style</code> 抽成独立的 <code>.js</code> 和 <code>.css</code> 文件。就像下面这样。</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!-- ./src/App.vue --&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">    &lt;img src=<span class="string">"./assets/hello.png"</span>&gt;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line">&lt;script src=<span class="string">"./app.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;style src=<span class="string">"./app.css"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>Vue 组件和模板语法是 Vue 的核心概念，我们在后面会以实战的形式重点讲解这些内容。</p><p>最后是我们的 <code>src/router/index.js</code> 文件，这个是 Vue 为我们提供的路由，我们在这个文件里面通过 <code>routes</code> 数组定义了所有我们项目需要用到的页面，比如初始化时为我们生成的 <code>HelloWorld.vue</code> 就是我们的网站首页 – 我们打开浏览器访问到的第一个页面，因为它的路径（<code>path</code>）定义为 <code>/</code> 。此外一个页面定义还需要 <code>name</code>，它代表此页面在 <code>vue-router</code> 中的标识符，<code>component</code> 代表此页面需要渲染的组件页面。</p><figure class="highlight js"><figcaption><span>src/router/index.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span>;</span><br><span class="line"><span class="keyword">import</span> HelloWorld <span class="keyword">from</span> <span class="string">'@/components/HelloWorld'</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(Router);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'/'</span>,</span><br><span class="line">      name: <span class="string">'HelloWorld'</span>,</span><br><span class="line">      component: HelloWorld,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>最后是 <code>src/components/HelloWorld.vue</code> 文件。</p><p>我们可以看到，其结构大致与 <code>App.vue</code> 类似。其中也有一些不同，比如 <code>script</code> 里面的 <code>data</code> 字段，还有 <code>template</code> 中的 <code>{{ }}</code> 语法。这个我们会在下一节进行讲解。</p><figure class="highlight html"><figcaption><span>src/components/HelloWorld.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"hello"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; msg &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Essential Links<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"https://vuejs.org"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          Core Docs</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"https://forum.vuejs.org"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          Forum</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"https://chat.vuejs.org"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          Community Chat</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"https://twitter.com/vuejs"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          Twitter</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"http://vuejs-templates.github.io/webpack/"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          Docs for This Template</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Ecosystem<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"http://router.vuejs.org/"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          vue-router</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"http://vuex.vuejs.org/"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          vuex</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"http://vue-loader.vuejs.org/"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          vue-loader</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span></span></span><br><span class="line"><span class="tag">          <span class="attr">href</span>=<span class="string">"https://github.com/vuejs/awesome-vue"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">target</span>=<span class="string">"_blank"</span></span></span><br><span class="line"><span class="tag">        &gt;</span></span><br><span class="line">          awesome-vue</span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">  name: <span class="string">'HelloWorld'</span>,</span></span><br><span class="line">  data() &#123;</span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">      msg: <span class="string">'Welcome to Your Vue.js App'</span>,</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Add "scoped" attribute to limit CSS to this component only --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line">h1, h2 &#123;</span><br><span class="line">  font-weight: normal;</span><br><span class="line">&#125;</span><br><span class="line">ul &#123;</span><br><span class="line">  list-style-type: none;</span><br><span class="line">  padding: 0;</span><br><span class="line">&#125;</span><br><span class="line">li &#123;</span><br><span class="line">  display: inline-block;</span><br><span class="line">  margin: 0 10px;</span><br><span class="line">&#125;</span><br><span class="line">a &#123;</span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#42b983</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当我们打开浏览器时，地址为：<code>http://localhost:8080/</code> 此时路径为 <code>/</code>，激活 <code>HelloWorld.vue</code> 组件，所以最后我们整个项目渲染 <code>App.vue</code> 的内容，显示的结构即为：</p><ul><li>一张 Vue logo 图</li><li>我们的 <code>HelloWorld.vue</code> 组件的内容</li></ul><p><img alt="App" data-src="././fd30e4f820c680abbd7d34b554704551"></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>通过一窥 <code>vue-cli</code> 为我们初始化的项目代码，我们可以学到如下的知识：</p><ul><li>Vue 通过组件来组织项目，单个组件就是我们传统的 Web 三剑客：HTML、JavaScript、CSS。</li><li>Vue 通过路由来定义多个页面，并且进行页面之间的跳转</li><li>一个页面是一个组件，一个组件可以由很多组件组成，通过这种组合式的思想，我们可以编写任意复杂的项目。</li></ul><h2 id="编写你的第一个-Vue-页面"><a href="#编写你的第一个-Vue-页面" class="headerlink" title="编写你的第一个 Vue 页面"></a>编写你的第一个 Vue 页面</h2><p>下面我们来编写我们的迷你淘宝的首页。</p><p>在 <code>src/components</code> 下面创建 <code>Home.vue</code> 文件，然后编写如下代码。</p><figure class="highlight html"><figcaption><span>src/components/Home.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">'home'</span>,</span></span><br><span class="line">    data () &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        msg: <span class="string">'Welcome to Your Vue.js App'</span></span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在上面，我们创建了一个名为 <code>Home.vue</code> 的 Vue 组件，可以看到它和我们之前的 <code>HelloWorld.vue</code> 的内容大致相仿，但是也有一些不同的地方。</p><p>首先，我们没有加入 <code>style</code> 部分，因为本教程致力于讲解如何用 Vue 实现一个迷你淘宝的功能逻辑部分，如果加入了过多无关的元素会让讲解变得复杂，代码也不容易理解。</p><blockquote><p>如果有机会，后面我会出一篇新教程，基于此教程专门讲解如何让我们的项目更加美观，敬请期待。</p></blockquote><p>其次，我们在 <code>script</code> 中引入了 <code>data</code> ，在 <code>template</code> 引入了插值语法 <code>{{var}}</code>。</p><p>其中 <code>data</code> 是声明此组件的初始化数据，而 <code>{{var}}</code> 插值语法是方便将数据渲染到视图模板中。</p><p>接着，我们在 <code>src/router/index.js</code> 路由中声明 <code>Home</code> 组件。</p><figure class="highlight js"><figcaption><span>src/router/index.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span>;</span><br><span class="line">[tuture-del]<span class="keyword">import</span> HelloWorld <span class="keyword">from</span> <span class="string">'@/components/HelloWorld'</span>;</span><br><span class="line">[tuture-add]<span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'@/components/Home'</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(Router);</span><br><span class="line"></span><br><span class="line">[tuture-omit]</span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'/'</span>,</span><br><span class="line">[tuture-del]      name: <span class="string">'HelloWorld'</span>,</span><br><span class="line">[tuture-del]      component: HelloWorld,</span><br><span class="line">[tuture-add]      name: <span class="string">'Home'</span>,</span><br><span class="line">[tuture-add]      component: Home,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>现在我们保存代码，打开浏览器，看到的内容应该就和我们在 <code>Home.vue</code> 里面编写的内容一样。</p><p><img alt="Home.vue" data-src="././edd8a53811e78bacd91ace31c3691c70"></p><h2 id="使用路由进行多页面跳转"><a href="#使用路由进行多页面跳转" class="headerlink" title="使用路由进行多页面跳转"></a>使用路由进行多页面跳转</h2><p>一个经典的商城页应该要包括如下部分：</p><ul><li>商品展示列表 （<code>Home.vue</code>）</li><li>商品详情（<code>Detail.vue</code>）</li><li>购物车（<code>Cart.vue</code>）</li></ul><p>这里因为我们追求简单，也将商品的后台管理内容 （<code>Admin.vue</code>）也放入了我们的项目中。</p><p>现在我们先来实现商品展示列表，购物车，和后台管理页的模板内容，因为商品详情页后面将会使用组件进行复用，所以这里我们暂时先不创建。</p><p>首先修改 <code>App.vue</code> ，加入三个导航链接 <code>router-link</code>。<code>router-link</code> 和 <code>a</code> 标签类似，只不过 Vue 为它添加一些额外的优化逻辑。</p><p>添加的三个导航链接用户让用户方便的调整到自己想看的页面。</p><figure class="highlight html"><figcaption><span>src/App.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">[tuture-del]    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"./assets/logo.png"</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;<span class="name">nav</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"nav__left"</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/admin"</span>&gt;</span>Admin<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">[tuture-add]            <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/cart"</span>&gt;</span>Cart<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">[tuture-add]          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">[tuture-add]        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]    <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接着我们编写 <code>Admin.vue</code> 组件，但这里稍微有点不同，即我们在 <code>src/pages</code> 下创建 <code>Admin.vue</code> 组件，因为对于页面级组件，我们倾向于将其放到一个特殊 <code>pages</code> 文件夹，这样方便组织项目。</p><figure class="highlight html"><figcaption><span>src/pages/Admin.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">'home'</span>,</span></span><br><span class="line">    data () &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        msg: <span class="string">'Welcome to the Admin Page'</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后是我们的购物车页面 <code>Cart.vue</code> </p><figure class="highlight html"><figcaption><span>src/pages/Cart.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">    name: <span class="string">'home'</span>,</span></span><br><span class="line">    data () &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        msg: <span class="string">'Welcome to the Cart Page'</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最后是我们的商品详情列表 <code>Home.vue</code>，只不过这一次我们需要将它从 <code>src/components/Home.vue</code> 移动到 <code>src/pages/Home.vue</code> 下。</p><figure class="highlight html"><figcaption><span>src/pages/Home.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>完成三个页面，接着就是在我们的 <code>src/routes/index.js</code> 中导入并申请上面三个页面。</p><figure class="highlight js"><figcaption><span>src/router/index.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span>;</span><br><span class="line">[tuture-del]<span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'@/components/Home'</span>;</span><br><span class="line">[tuture-add]<span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'@/pages/Home'</span>;</span><br><span class="line">[tuture-add]<span class="keyword">import</span> Admin <span class="keyword">from</span> <span class="string">'@/pages/Admin'</span>;</span><br><span class="line">[tuture-add]<span class="keyword">import</span> Cart <span class="keyword">from</span> <span class="string">'@/pages/Cart'</span>;</span><br><span class="line"></span><br><span class="line">Vue.use(Router);</span><br><span class="line"></span><br><span class="line">[tuture-omit]</span><br><span class="line">      name: <span class="string">'Home'</span>,</span><br><span class="line">      component: Home,</span><br><span class="line">    &#125;,</span><br><span class="line">[tuture-add]    &#123;</span><br><span class="line">[tuture-add]      path: <span class="string">'/admin'</span>,</span><br><span class="line">[tuture-add]      name: <span class="string">'Admin'</span>,</span><br><span class="line">[tuture-add]      component: Admin,</span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line">[tuture-add]    &#123;</span><br><span class="line">[tuture-add]      path: <span class="string">'/cart'</span>,</span><br><span class="line">[tuture-add]      name: <span class="string">'Cart'</span>,</span><br><span class="line">[tuture-add]      component: Cart,</span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>保存我们写好的代码，然后打开浏览器，我们可以看到下面的效果：</p><p><img alt="Multi-Route" data-src="././bb0a5726073b43a60328bf2f73a86bef"></p><p>你可以点击头部的三个导航链接，下面的标题内容会随着点击的链接变化，恭喜你！你已经拥有了一个多页面的项目了。</p><h2 id="使用嵌套路由和动态路由合理组织页面"><a href="#使用嵌套路由和动态路由合理组织页面" class="headerlink" title="使用嵌套路由和动态路由合理组织页面"></a>使用嵌套路由和动态路由合理组织页面</h2><p>随着页面的增多，如果我们把所有的页面都塞到一个 <code>routes</code> 数组里面会显得很乱，你无法确定哪些页面存在关系。还好 <code>vue-router</code> 提供给我们嵌套路由的功能，让我们能把相关联的页面组织在一起。</p><p>在我们的迷你淘宝项目中，后台管理页 <code>Admin</code> 可以涉及到很多操作页面比如：</p><ul><li><code>/create</code> 创建新的商品</li><li><code>/edit</code> 编辑商品信息</li></ul><p>让我们通过嵌套路由的方式将它们组织在一起。</p><figure class="highlight js"><figcaption><span>src/router/index.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span>;</span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span>;</span><br><span class="line">[tuture-add]</span><br><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'@/pages/Home'</span>;</span><br><span class="line">[tuture-del]<span class="keyword">import</span> Admin <span class="keyword">from</span> <span class="string">'@/pages/Admin'</span>;</span><br><span class="line"><span class="keyword">import</span> Cart <span class="keyword">from</span> <span class="string">'@/pages/Cart'</span>;</span><br><span class="line"></span><br><span class="line">[tuture-add]<span class="comment">// Admin Components</span></span><br><span class="line">[tuture-add]<span class="keyword">import</span> Index <span class="keyword">from</span> <span class="string">'@/pages/admin/Index'</span>;</span><br><span class="line">[tuture-add]<span class="keyword">import</span> New <span class="keyword">from</span> <span class="string">'@/pages/admin/New'</span>;</span><br><span class="line">[tuture-add]<span class="keyword">import</span> Products <span class="keyword">from</span> <span class="string">'@/pages/admin/Products'</span>;</span><br><span class="line">[tuture-add]<span class="keyword">import</span> Edit <span class="keyword">from</span> <span class="string">'@/pages/admin/Edit'</span>;</span><br><span class="line">[tuture-add]</span><br><span class="line">Vue.use(Router);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">[tuture-omit]</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'/admin'</span>,</span><br><span class="line">      name: <span class="string">'Admin'</span>,</span><br><span class="line">[tuture-del]      component: Admin,</span><br><span class="line">[tuture-add]      component: Index,</span><br><span class="line">[tuture-add]      children: [</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          path: <span class="string">'new'</span>,</span><br><span class="line">[tuture-add]          name: <span class="string">'New'</span>,</span><br><span class="line">[tuture-add]          component: New,</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          path: <span class="string">''</span>,</span><br><span class="line">[tuture-add]          name: <span class="string">'Products'</span>,</span><br><span class="line">[tuture-add]          component: Products,</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          path: <span class="string">'edit/:id'</span>,</span><br><span class="line">[tuture-add]          name: <span class="string">'Edit'</span>,</span><br><span class="line">[tuture-add]          component: Edit,</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'/cart'</span>,</span><br></pre></td></tr></table></figure><p>嵌套路由的用法就是给需要归为一类的页面设置一个入口页面，然后把这一类页面都放到这个路由页面路由定义的 <code>children</code> 字段数组中。</p><p>通过上面我们可以看到，我们的 <code>Admin</code> 类别下有四个组件，<code>Index</code> 是我们 <code>Admin</code> 类别的入口组件，也是作为 <code>path = /admin</code> 的渲染组件，然后其他组件就放到 <code>path = /admin</code> 这个路由定义的 <code>children</code> 数组里，其定义和其他父级一致。</p><p>这样的嵌套写法带来了两个好处：</p><ul><li>很清晰的组织了一类页面，方便阅读。</li><li>在定于路由的 <code>path</code> 的时候，复用了父级的 <code>path</code>，即现在我们的 <code>New</code> 这个路由，它在浏览器中访问的路径为：<code>&#39;/admin&#39; +  &#39;new&#39;</code>，如果我们统一放到 <code>routes</code> 数组的第一级定义，那么后面的 <code>Products</code> 和 <code>Edit</code> 的 <code>path</code> 都要带上诸如 <code>/admin</code> 和 <code>/admin/edit/:id</code> 这样长长的路径，显得特别复杂。</li></ul><p>这里还有一个改变就是，我们发现 <code>Edit</code> 这个路由的 <code>path</code> 有点不太一样，它有个特殊的标志 <code>edit/:id</code>，这种写法被称为动态路由，即 <code>:id</code> 会匹配任意字符串，所以用户访问 <code>/admin/edit/&lt;any-string&gt;</code> 都会激活 <code>Edit</code> 路由，从而渲染 <code>Edit.vue</code> 组件。</p><p>这里我们接着来创建一下 <code>Edit.vue</code> 组件</p><figure class="highlight html"><figcaption><span>src/pages/admin/Edit.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is Admin/Edit/&#123;&#123;$route.params.id&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，当用户访问 <code>/admin/edit/:id</code>，会激活渲染 <code>Edit.vue</code> 组件，我们可以通过 <code>$route.params.id</code> 的方式获取用户输入的路径 <code>:id</code> 部分。比如我们在浏览器中输入 <code>/admin/edit/52tuture</code>，那么浏览器将会以 <code>h1</code> 的形式打出 <code>&quot;This is Admin/Edit/52tuture&quot;</code>。</p><p><code>$route</code> 这个变量是 Vue 在运行时为我们自动插入到所有组件属性中的，所有我们不用手动去管理它。</p><p>然后创建 <code>Index.vue</code> 入口组件，可以看到，它作为嵌套路由的入口级组件，和我们之前在 <code>App.vue</code> 里面看到的样子类似，在其中会有 <code>router-link</code> 导向更深层级的路由，<code>router-view</code> 用于渲染子路由组件。</p><figure class="highlight html"><figcaption><span>src/pages/admin/Index.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"admin-new"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-lg-3 col-md-3 col-sm-12 col-xs-12"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"admin-menu"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/admin"</span>&gt;</span>View Products<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/admin/new"</span>&gt;</span>New Products<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接着创建 <code>New.vue</code> 、<code>Products.vue</code> 。</p><figure class="highlight html"><figcaption><span>src/pages/admin/New.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is Admin/New<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><figcaption><span>src/pages/admin/Products.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is Admin<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>保存我们编写的内容，打开浏览器，我们可以看到如下内容：</p><p><img alt="52tuture" data-src="././d652313c1dcd035889405c8d238c8a21"></p><h2 id="了解-Vue-模板语法和双向绑定"><a href="#了解-Vue-模板语法和双向绑定" class="headerlink" title="了解 Vue 模板语法和双向绑定"></a>了解 Vue 模板语法和双向绑定</h2><p>当我们完成了迷你淘宝的基本页面框架之后，我们就可以开始考虑具体页面的内容了。首先我们要考虑的就是数据的来源，即添加商品页面，有了添加商品的入口，我们就可以展示商品列表，获取商品详情，甚至是修改商品信息。</p><p>我们在 <code>components</code> 中创建 <code>ProductForm.vue</code> 表单组件，编写如下代码：</p><figure class="highlight html"><figcaption><span>src/components/products/ProductForm.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> @<span class="attr">submit.prevent</span>=<span class="string">"saveProduct"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-lg-5 col-md-5 col-sm-12 col-xs-12"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"Name"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"model.name"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">"name"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"form-control"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Price<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"number"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"form-control"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"Price"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"model.price"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">"price"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Manufacturer<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"form-control"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"model.manufacturer"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">"manufacturer"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">"manufacturer in manufacturers"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">:value</span>=<span class="string">"manufacturer._id"</span> <span class="attr">:selected</span>=<span class="string">"manufacturer._id == (model.manufacturer &amp;&amp; model.manufacturer._id)"</span>&gt;</span>&#123;&#123;manufacturer.name&#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-lg-4 col-md-4 col-sm-12 col-xs-12"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Image<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">lass</span>=<span class="string">"form-control"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"Image"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"model.image"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">"image"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"form-control"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>Description<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"form-control"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"Description"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">rows</span>=<span class="string">"5"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"model.description"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">name</span>=<span class="string">"description"</span></span></span><br><span class="line"><span class="tag">         &gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group new-button"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"button"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-pencil"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- Conditional rendering for input text --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-if</span>=<span class="string">"isEditing"</span>&gt;</span>Update Product<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">v-else</span>&gt;</span>Add Product<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="actionscript">  props: [<span class="string">'model'</span>, <span class="string">'manufacturers'</span>, <span class="string">'isEditing'</span>],</span></span><br><span class="line">  methods: &#123;</span><br><span class="line">    saveProduct() &#123;</span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.$emit(<span class="string">'save-product'</span>, <span class="keyword">this</span>.model)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这段代码看起来很长，你可能被吓到了，让我们一段一段来拆解它。</p><p>首先它由两个部分组成，分别是 <code>script</code> 和 <code>template</code> ，我们先来看一看 <code>script</code> 部分。</p><h3 id="Vue-实例：Methods-和-Props"><a href="#Vue-实例：Methods-和-Props" class="headerlink" title="Vue 实例：Methods 和 Props"></a>Vue 实例：Methods 和 Props</h3><p>首先它多可了两个我们之前没看过 <code>props</code> 和 <code>methods</code> ，<code>props</code> 是 Vue 进行组件之间传参的形式，比如这里我们的 <code>props</code> 接收来自父组件的三个参数：<code>model</code>、<code>manufacturers</code>、<code>isEditing</code>。</p><p>然后是 <code>methods</code> ，<code>methods</code> 是用来定义在组件中会用到的一些方法，如果说我们前面提到的 <code>data</code> ，是从数据从逻辑层（JS）向视图层（Html）流动的话，那么这里的 <code>methods</code> 就是视图层触发事件，如 click、submit等，反过来修改逻辑层的数据的方法，<code>methods</code> 使得数据可以双向流动。比如这里，我们定义了一个 <code>saveProduct</code> 方法，就是当用户填写完商品信息的表单之后，点击提交按钮会触发的方法，在 <code>saveProduct</code> 内部，我们调用了父组件的 <code>save-product</code> 方法，并把修改后的 <code>this.mode</code> 变量内容传给父组件。所以这里我们还可以看到，<code>methods</code> 不仅可以使得数据可以双向流动，而且还可以在子组件反向操作父组件的内容，使得数据还可以上下流动。</p><h3 id="模板语法：v-bind、v-on"><a href="#模板语法：v-bind、v-on" class="headerlink" title="模板语法：v-bind、v-on"></a>模板语法：v-bind、v-on</h3><p>接下来我们再来谈一谈 <code>template</code> 里面发生的事情。</p><p>可以看到 <code>template</code> 里面就是一个表单，这个表单定义了一个 <code>submit</code> 事件，这个事件触发会调用我们上面提到的 <code>saveProduct</code> 方法，但是这里好像多了一些我们之前在 <code>HTML</code> 里面没有看到的内容，接着我们定义了好几个 <code>class</code> 为 <code>form-group</code> 的元素块，每个块代表我们创建商品所需要填写的相关信息，最后的 <code>form-group</code> 是我们提交商品信息的按钮，可以看到它它里面也有一些我们之前在 HTML 里面没有看到的信息，不用担心，我们接下来都会一一讲解。</p><p>首先我们来看一看 <code>form</code> 元素的 <code>submit</code> 事件提交部分，它的样子怪怪的，我们需要再进行一下拆解。首先我们先拿掉 <code>prevent</code> ，它变成了 <code>@submit=&quot;saveProduct&quot;</code>，接着我们将 <code>@</code> 替换成 <code>v-on</code>，它变成了 <code>v-on:submit=&quot;saveProduct&quot;</code> ，这是 Vue 的模板语法，通过 <code>v-on</code> 的方式接管了之前在 HTML 中 <code>onEvent</code> 。</p><p>比如之前我们在 HTML 中的写法是这样的：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">"alert('I love tuture')"</span>&gt;</span></span><br><span class="line">Hello Tuture</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>现在在 Vue 的模板语法中我们需要写出这样：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-on:click</span>=<span class="string">"alert('I love tuture')"</span>&gt;</span></span><br><span class="line">Hello Tuture</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>类似的 <code>onEvent</code> 都要改成 <code>v-on:Event</code>。然后这样写显得比较冗余，所以 Vue 支持简化写法，用 <code>@</code> 替换 <code>v-on:</code> 部分，我们就可以写出这样：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">"alert('I love tuture')"</span>&gt;</span></span><br><span class="line">Hello Tuture</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>调用事件之后我们一般有一些这样的操作，比如禁用浏览器默认行为，然后自己去处理事件，获取后端数据，以前我们会这样写：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onclick</span>=<span class="string">"saveProduct()"</span>&gt;</span></span><br><span class="line">Hello Tuture</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> saveProduct = <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span></span><br><span class="line">  e.preventDefault();</span><br><span class="line"></span><br><span class="line"><span class="actionscript">  <span class="comment">// do something you like</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是这样写又显得特别繁琐了，Vue 也觉得这样可以简化，于是我们直接将这些禁止默认行为的调用直接作为绑定事件的属性来进行处理，于是乎在 Vue 中我们可以写出这样：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div @click.prevent=<span class="string">"saveProduct"</span>&gt;</span><br><span class="line">  Hello Tuture</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  methods: &#123;</span><br><span class="line">    saveProduct() &#123;</span><br><span class="line">      <span class="comment">// do something you like</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>不知道看了上面的长文，你有没有一点晕，不管你晕不晕，我是得喝口水缓一下。 - v -</p><h3 id="模板语法：v-model-双向绑定"><a href="#模板语法：v-model-双向绑定" class="headerlink" title="模板语法：v-model 双向绑定"></a>模板语法：v-model 双向绑定</h3><p>前面我们提到通过 <code>{{}}</code> 插值语法渲染来自 <code>data</code> 的数据实现了逻辑层向视图层的数据流动，通过 <code>methods</code> 在视图层操作逻辑层的数据，实现了视图层的数据向逻辑层的数据流动，从而达到了双向绑定，当我们的应用越来越复杂，我们会发现这样的数据双向流动会越来越频繁，而且粒度也会大小不一，有很多单纯修改某个值的方法调用就会显得特别繁杂，因此 Vue 通过提供 <code>v-mode</code> 进行了视图层和逻辑层的双向绑定，让我们来看我们项目中的例子, 也就是第一个 <code>form-group</code> ：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span></span></span><br><span class="line"><span class="tag">  <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">placeholder</span>=<span class="string">"Name"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-model</span>=<span class="string">"model.name"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">name</span>=<span class="string">"name"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">lass</span>=<span class="string">"form-control"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>这里我们通过申明 <code>v-mode</code> 将此 input 的值和我们在 Vue 实例中的 <code>model</code> 的 <code>name</code> 属性进行了双向绑定，即当 <code>model.name</code> 发生变化，input 的值也会跟着变化，当 input 的值发生变化，我们 <code>model.name</code> 的值也会被修改，这一切都是自动发生的，不需要我们额外的添加 <code>methods</code> 里面的方法调用来手动修改。</p><h3 id="模板语法：循环"><a href="#模板语法：循环" class="headerlink" title="模板语法：循环"></a>模板语法：循环</h3><p>接下来我们看看第三个 <code>form-group</code>，就是选择我们商品的 <code>manufacturer</code> 的那个，我们可以从这段奇怪的代码里看到一些熟悉的东西，比如我们的 <code>for in</code> 循环，还有一些不熟悉的，比如 <code>v-model</code>，比如 <code>:value</code> 和 <code>:selected</code>，<code>v-model</code> 我们晚点再讲，先让我们来看一看 <code>for in</code> 循环和 <code>:value</code>。</p><p>我们已经看到在 Vue 模板中我们可以使用如下的功能：</p><ul><li><code>{{}}</code> 插值语法将 <code>data</code> 渲染到 HTML 元素内容中</li><li><code>v-on</code> 或者简化写法 <code>@</code> ，等用来取代 HTML 的事件绑定</li></ul><p>有了上面的功能，我们可以让 HTML 动起来了，但是还缺点什么，比如我们的 HTML 属性，如 <code>id</code>、<code>class</code> 等，是不是也能动态的获取变化值，这里的动态值就是通过 <code>:id=&quot;id&quot;</code> 或者 <code>:class=&quot;class&quot;</code> 等来操作的，其中 <code>:id</code> 是 <code>v-bind:id</code> 的简化写法，<code>:id=&quot;id&quot;</code> 后面的字符串中的 <code>id</code> 代表我们在 data 中定义的变量值，它可以动态的变化。</p><p>好了，Vue 替我们接管了 HTML 元素属性值、事件处理、元素内容，这些都还只属于原来 HTML 的部分，它更强大的一点就是将 JS 的功能引入了模板语法中，使得我们可以实现类似循环，条件选择操作等功能。</p><p>比如我们第三个 <code>form-group</code> 中看到的 <code>v-for=&quot;manufacturer in manufacturers&quot;</code> 。这个语法就牛逼了，它允许我们遍历一个数组并且批量的生成一系列 HTML 元素，瞬间可以完成我们的商品列表的展示有木有，因为商品列表展示就是一系列相同结构，不同内容的元素组成的。这里 <code>manufacturers</code> 数组是组件 <code>data</code> 中的数据，<code>manufacturer</code> 是遍历中的单个数据。</p><p>我们来看个例子理解一下：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">manufacturers = [</span></span><br><span class="line"><span class="comment">  &#123; _id: 1, name: 'Apple' &#125;,</span></span><br><span class="line"><span class="comment">  &#123; _id: 2, name: 'Huawei' &#125;</span></span><br><span class="line"><span class="comment">]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">model = &#123; _id: 1, name: 'Apple' &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">"manufacturer in manufacturers"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">option</span> <span class="attr">:value</span>=<span class="string">"manufacturer._id"</span> <span class="attr">:selected</span>=<span class="string">"manufacturer._id == (model.manufacturer &amp;&amp; model.manufacturer._id)"</span>&gt;</span>&#123;&#123;manufacturer.name&#125;&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最后渲染的结果为：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"1"</span> <span class="attr">selected</span>=<span class="string">"true"</span>&gt;</span>Apple<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"2"</span> <span class="attr">selected</span>=<span class="string">"false"</span>&gt;</span>Huawei<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="模板语法：条件选择"><a href="#模板语法：条件选择" class="headerlink" title="模板语法：条件选择"></a>模板语法：条件选择</h3><p>上面的讲述了循环是如何在 Vue 中使用的，下面我们来看一看条件语法是如何在 Vue 中使用的，让我们看到最后一个 <code>form-group</code>，就是我们最后提交表单的按钮那个部分。可以看到在代码中出现了 <code>v-if</code> 和 <code>v-else</code> 等内容，当 <code>isEditing</code> 为 <code>true</code> 的时候，Vue 就会渲染 <code>Update Product</code> 按钮，否则就会渲染 <code>Add Product</code> 按钮。</p><p>当然你可以添加诸如 <code>v-else-if</code> 的标签来做多重判断。</p><h3 id="Vue-组件组合"><a href="#Vue-组件组合" class="headerlink" title="Vue 组件组合"></a>Vue 组件组合</h3><p>编写完上面的表单之后，我们在 <code>New.vue</code> 中引入我们创建的表单组件：</p><figure class="highlight html"><figcaption><span>src/pages/admin/New.vue</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-del]  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-del]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">[tuture-del]      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is Admin/New<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">[tuture-del]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-del]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;<span class="name">product-form</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]    @<span class="attr">save-product</span>=<span class="string">"addProduct"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]    <span class="attr">:model</span>=<span class="string">"model"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]    <span class="attr">:manufacturers</span>=<span class="string">"manufacturers"</span></span></span><br><span class="line"><span class="tag">[<span class="attr">tuture-add</span>]  &gt;</span></span><br><span class="line">[tuture-add]  <span class="tag">&lt;/<span class="name">product-form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">[tuture-add]<span class="keyword">import</span> ProductForm <span class="keyword">from</span> <span class="string">'@/components/products/ProductForm.vue'</span>;</span></span><br><span class="line"><span class="javascript">[tuture-add]<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">[tuture-add]  data() &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="keyword">return</span> &#123;</span></span><br><span class="line">[tuture-add]      model: &#123;&#125;,</span><br><span class="line">[tuture-add]      manufacturers: [</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]          _id: <span class="string">'sam'</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]          name: <span class="string">'Samsung'</span>,</span></span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]          _id: <span class="string">'apple'</span>,</span></span><br><span class="line"><span class="actionscript">[tuture-add]          name: <span class="string">'Apple'</span>,</span></span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]      ],</span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  methods: &#123;</span><br><span class="line">[tuture-add]    addProduct(model) &#123;</span><br><span class="line"><span class="javascript">[tuture-add]      <span class="built_in">console</span>.log(<span class="string">'model'</span>, model);</span></span><br><span class="line">[tuture-add]    &#125;,</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  components: &#123;</span><br><span class="line"><span class="actionscript">[tuture-add]    <span class="string">'product-form'</span>: ProductForm</span></span><br><span class="line">[tuture-add]  &#125;</span><br><span class="line">[tuture-add]&#125;</span><br><span class="line">[tuture-add]<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当一个组件要使用在模板语法中使用另外一个组件时，需要什么此组件，即在组件的 <code>components</code> 属性中申明要使用的组件，比如我们上面使用名为 <code>&#39;product-form&#39;</code> 的名称来申明使用 <code>ProductForm</code> 组件，这样在 <code>template</code> 中我们就可以以 <code>&lt;product-form /&gt;</code> 形式使用导入的表单组件。</p><p>同时我们在组件的 <code>data</code> 中定义了 <code>model</code> 和 <code>manufacturers</code> 以及在 <code>methods</code> 中定义了 <code>addProduct</code> 方法，并将它们以属性绑定 <code>:model=&quot;model&quot;</code>、<code>:manufacturers=&quot;manufacturers&quot;</code> 和事件绑定 <code>@save-product=&quot;saveProduct&quot;</code> 的方式传递给表单组件。</p><p>当保存上面编写的代码之后，我们打开浏览器，点击导航链接 <code>Admin</code>，然后点击子导航链接 <code>New Products</code>，切换到我们的 <code>New.vue</code> 添加商品页面，我们可以看到如下的效果：</p><p><img alt="New.vue" data-src="././2a340eeb04a07c1aae2bcd0387931c52"></p><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>到现在为止，我们已经了解了 Vue 的基础部分，包括：</p><ul><li>用路由进行多页面的调整和导航</li><li>用嵌套路由和动态路由合理组织页面</li><li>Vue 组件和 Vue 实例</li><li>Vue 模板语法</li></ul><p>有了这些知识我们可以实现绝大多数前端功能了，并且可以完成一些比较小的前端项目，如果要完成大型且数据逻辑复杂的应用，我们目前学到的知识就力不从心了，但是没关系，我们将在后面学习 Vuex 这一前端状态管理工具，有了 Vuex 的加持，我们就能用 Vuex 写出任意复杂的应用了。</p><p>但是请先别着急，让我们先做点别的事，比如，干掉我们硬编码的假数据，试试真实的数据，并且还能持久化保存我们的数据，这就需要后端的介入了，在下一节中，我会带你手把手实现一个 Node.js 后端 API 应用，有了它，我们的前端就真正的活起来了，数据也可以持久保存了！</p>]]></content>
    
    <summary type="html">
    
      Vue 是尤雨溪在2014年创建的一个前端框架，目前 Github Star 数高达150K，是 Star 数最高的前端项目，并且 Vue 有着极为活跃的社区生态以及专职团队进行维护以确保项目可以健康长久的发展。 目前中国很多互联网公司前端程序员的招聘要求都要求程序员掌握 Vue，像滴滴、美团、饿了么等大厂也在重度使用 Vue 进行开发，并且有着像 Element 、mpvue、iView 这样优秀的基于 Vue 开源项目存在，所以学习 Vue 是一个不错的投资，当你学会 Vue，就可以快速开发项目，这样不仅可以接外包挣外快，而且当有了一定的项目经验，还可以在一线互联网大厂找到一份不错的工作。 看到这里你心动了嘛？心动不如行动！而最幸运的是，本教程将会一步一步带你以实战的方式实现一个 real-life （真实世界中的运行的）项目，并在实战的过程中，了解 Vue 的全貌，现在就打开电脑，跟随者我的脚步，这一次彻底掌握 Vue 开发！
    
    </summary>
    
    
    
      <category term="JavaScript" scheme="https://tuture.co/tags/JavaScript/"/>
    
      <category term="Vue" scheme="https://tuture.co/tags/Vue/"/>
    
      <category term="Node" scheme="https://tuture.co/tags/Node/"/>
    
      <category term="MongoDB" scheme="https://tuture.co/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>从零开始用 Express + MongoDB 搭建图片分享社区（二）</title>
    <link href="https://tuture.co/2019/10/16/29f41c0/"/>
    <id>https://tuture.co/2019/10/16/29f41c0/</id>
    <published>2019-10-16T00:00:00.509Z</published>
    <updated>2019-10-16T02:52:55.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="实现图片上传功能"><a href="#实现图片上传功能" class="headerlink" title="实现图片上传功能"></a>实现图片上传功能</h2><p>第一步，我们先实现图片上传功能。创建 <code>public/upload</code> 文件夹，用于存放用户上传的图片：</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir -p public/upload</span><br></pre></td></tr></table></figure><p>然后安装 multer 中间件用于处理文件上传：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install multer</span><br></pre></td></tr></table></figure><p>在 server/routes.js 模块中，我们初始化 multer 中间件，然后将其添加到上传图片的路由中（即 <code>POST /images</code>）：</p><figure class="highlight js"><figcaption><span>server/routes.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">'multer'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line">[tuture-add]<span class="keyword">const</span> upload = multer(&#123; <span class="attr">dest</span>: path.join(__dirname, <span class="string">'public/upload/temp'</span>) &#125;);</span><br><span class="line"><span class="keyword">const</span> home = <span class="built_in">require</span>(<span class="string">'../controllers/home'</span>);</span><br><span class="line"><span class="keyword">const</span> image = <span class="built_in">require</span>(<span class="string">'../controllers/image'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">  router.get(<span class="string">'/'</span>, home.index);</span><br><span class="line">  router.get(<span class="string">'/images/:image_id'</span>, image.index);</span><br><span class="line">[tuture-del]  router.post(<span class="string">'/images'</span>, image.create);</span><br><span class="line">[tuture-add]  router.post(<span class="string">'/images'</span>, upload.single(<span class="string">'file'</span>), image.create);</span><br><span class="line">  router.post(<span class="string">'/images/:image_id/like'</span>, image.like);</span><br><span class="line">  router.post(<span class="string">'/images/:image_id/comment'</span>, image.comment);</span><br><span class="line">  app.use(router);</span><br></pre></td></tr></table></figure><p>上述代码有两点需要讲解：</p><ul><li>第 6 行，在初始化 <code>upload</code> 中间件时，传入 <code>dest</code> 选项指定保存上传文件的路径，这里我们选择在 public/upload 目录中再创建一个 temp 目录用于临时保存上传到的图片；</li><li>第 14 行，<code>router.post</code> 除第一个参数为 URL，后面可以跟任意多个中间件，这里我们将上传文件的中间件添加到 <code>image.create</code> 控制器的前面，确保先处理用户上传的文件。这里 <code>upload.single(&#39;file&#39;)</code> 表示只处理单个上传文件，并且字段名为 <code>file</code>，在后续中间件中就可以通过 <code>req.file</code> 进行获取。</li></ul><p>关于 multer 的详细用法，可以参考其<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2V4cHJlc3Nqcy9tdWx0ZXI=" title="https://github.com/expressjs/multer">文档<i class="fa fa-external-link"></i></span>。</p><p>在配置好上传文件的中间件后，相应地在控制器中加入获取并保存图片的代码：</p><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-add]<span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">[tuture-add]</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> viewModel = &#123;</span><br><span class="line">[tuture-omit]</span><br><span class="line">    res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    res.send(<span class="string">'The image:create POST controller'</span>);</span><br><span class="line">[tuture-add]    <span class="keyword">var</span> tempPath = req.file.path;</span><br><span class="line">[tuture-add]    <span class="keyword">var</span> imgUrl = req.file.filename;</span><br><span class="line">[tuture-add]    <span class="keyword">var</span> ext = path.extname(req.file.originalname).toLowerCase();</span><br><span class="line">[tuture-add]    <span class="keyword">var</span> targetPath = path.resolve(<span class="string">'./public/upload/'</span> + imgUrl + ext);</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]    <span class="keyword">if</span> (ext === <span class="string">'.png'</span> || ext === <span class="string">'.jpg'</span> || ext === <span class="string">'.jpeg'</span> || ext === <span class="string">'.gif'</span>) &#123;</span><br><span class="line">[tuture-add]      fs.rename(tempPath, targetPath, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">[tuture-add]        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]        res.redirect(<span class="string">'/images/'</span> + imgUrl);</span><br><span class="line">[tuture-add]      &#125;);</span><br><span class="line">[tuture-add]    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">[tuture-add]      fs.unlink(tempPath, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">[tuture-add]        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]        res.json(<span class="number">500</span>, &#123; <span class="attr">error</span>: <span class="string">'只允许上传图片文件.'</span> &#125;);</span><br><span class="line">[tuture-add]      &#125;);</span><br><span class="line">[tuture-add]    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  like: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The image:like POST controller'</span>);</span><br></pre></td></tr></table></figure><p><code>req.file</code> 是一个 Multer 文件对象，包括 <code>path</code>（上传到服务器的路径）、<code>filename</code>（服务器存储的文件名）和 <code>originalname</code>（文件初始名，即保存在客户端的文件名）等有用的属性。我截取了一张输出 <code>req.file</code> 所有字段的图片如下：</p><p><img alt data-src="./figure-4.png"></p><p>这里我们通过简单的后缀匹配来判断用户上传的是否为图片，如果是，则从临时目录 <code>tempPath</code> 存放到上传目录 <code>targetPath</code> 中，否则直接删除。上传成功后，通过 <code>res.redirect</code> 将页面重定向到刚刚上传的图片的详情页面。</p><h2 id="接入-MongoDB-数据库"><a href="#接入-MongoDB-数据库" class="headerlink" title="接入 MongoDB 数据库"></a>接入 MongoDB 数据库</h2><p>在上一步中，我们实现了文件上传，但是有一个很糟糕的问题：我们没有去记录上传了哪些图片，还有相应的信息（例如上传时间）。当我们关闭服务器再打开时，整个网站仿佛一下子“失忆”了。解决数据持久化存储最流行的方案无疑是数据库，而 MongoDB 凭借其优异的性能、可扩展性和灵活的数据模式，从众多数据库产品中脱颖而出。并且，MongoDB 的核心功能是基于 BSON（Binary JSON）实现的，甚至提供了 JavaScript Shell，因此在 Node 社区更是深受欢迎。所以，我们也将利用 MongoDB 实现 Instagrammy 的数据持久化存储。MongoDB 可以从其<span class="exturl" data-url="aHR0cHM6Ly93d3cubW9uZ29kYi5jb20vZG93bmxvYWQtY2VudGVyL2NvbW11bml0eQ==" title="https://www.mongodb.com/download-center/community">官网<i class="fa fa-external-link"></i></span>上下载。下载并安装好之后，新打开一个终端（命令控制台），运行以下命令打开数据库（Windows 用户可以搜索 mongo.exe 并打开）：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongod</span><br></pre></td></tr></table></figure><p>然后我们安装 Mongoose 这个 npm 包：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install mongoose</span><br></pre></td></tr></table></figure><p>Mongoose 是 MongoDB 最流行的 ODM（Object Document Mapping，对象文档映射），使用起来要比底层的 MongoDB Node 驱动更方便。</p><p>我们首先实现图片有关的数据模型。创建 models 目录，在其中添加 image.js 模块，并添加实现 <code>ImageSchema</code> 的代码：</p><figure class="highlight js"><figcaption><span>models/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ImageSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  title: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  description: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  filename: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  views: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  likes: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">0</span> &#125;,</span><br><span class="line">  timestamp: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ImageSchema.virtual(<span class="string">'uniqueId'</span>).get(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.filename.replace(path.extname(<span class="keyword">this</span>.filename), <span class="string">''</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'Image'</span>, ImageSchema);</span><br></pre></td></tr></table></figure><p>我们在第 6 行到第 13 行定义了一个 <code>Schema</code>，即数据对象的模式，描述了这个模型的所有字段及相应的属性。这里我们为 <code>ImageSchema</code> 定义了六个字段，每个字段都有其类型（必须），<code>views</code>、<code>likes</code> 和 <code>timestamp</code> 还有相应的默认值（可选）。除了普通字段外，我们还定义了<strong><em>虚字段</em></strong><code>uniqueId</code>。虚字段（virtuals）和普通字段的最大区别是不会保存到数据库中，而是在每次查询时临时计算，通常用于对普通字段进行格式调整或组合。在 <code>Schema</code> 定义完成后，我们将其编译为名为 <code>Image</code> 的模型并导出，方便在控制器中进行使用。</p><p>接着我们在 home 控制器中调用 <code>ImageModel</code> 来从数据库中获取全部图片：</p><figure class="highlight js"><figcaption><span>controllers/home.js</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-add]<span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line">[tuture-add]</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    <span class="keyword">const</span> viewModel = &#123;</span><br><span class="line">[tuture-del]      images: [</span><br><span class="line">[tuture-del]        &#123;</span><br><span class="line">[tuture-del]          uniqueId: <span class="number">1</span>,</span><br><span class="line">[tuture-del]          title: <span class="string">'示例图片1'</span>,</span><br><span class="line">[tuture-del]          description: <span class="string">''</span>,</span><br><span class="line">[tuture-del]          filename: <span class="string">'sample1.jpg'</span>,</span><br><span class="line">[tuture-del]          views: <span class="number">0</span>,</span><br><span class="line">[tuture-del]          likes: <span class="number">0</span>,</span><br><span class="line">[tuture-del]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-del]        &#125;,</span><br><span class="line">[tuture-del]        &#123;</span><br><span class="line">[tuture-del]          uniqueId: <span class="number">2</span>,</span><br><span class="line">[tuture-del]          title: <span class="string">'示例图片2'</span>,</span><br><span class="line">[tuture-del]          description: <span class="string">''</span>,</span><br><span class="line">[tuture-del]          filename: <span class="string">'sample2.jpg'</span>,</span><br><span class="line">[tuture-del]          views: <span class="number">0</span>,</span><br><span class="line">[tuture-del]          likes: <span class="number">0</span>,</span><br><span class="line">[tuture-del]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-del]        &#125;,</span><br><span class="line">[tuture-del]        &#123;</span><br><span class="line">[tuture-del]          uniqueId: <span class="number">3</span>,</span><br><span class="line">[tuture-del]          title: <span class="string">'示例图片3'</span>,</span><br><span class="line">[tuture-del]          description: <span class="string">''</span>,</span><br><span class="line">[tuture-del]          filename: <span class="string">'sample3.jpg'</span>,</span><br><span class="line">[tuture-del]          views: <span class="number">0</span>,</span><br><span class="line">[tuture-del]          likes: <span class="number">0</span>,</span><br><span class="line">[tuture-del]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-del]        &#125;,</span><br><span class="line">[tuture-del]      ],</span><br><span class="line">[tuture-del]    &#125;;</span><br><span class="line">[tuture-del]    res.render(<span class="string">'index'</span>, viewModel);</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> viewModel = &#123; <span class="attr">images</span>: [] &#125;;</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]    ImageModel.find(&#123;&#125;, &#123;&#125;, &#123; <span class="attr">sort</span>: &#123; <span class="attr">timestamp</span>: <span class="number">-1</span> &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, images</span>) </span>&#123;</span><br><span class="line">[tuture-add]      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]      viewModel.images = images;</span><br><span class="line">[tuture-add]      res.render(<span class="string">'index'</span>, viewModel);</span><br><span class="line">[tuture-add]    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在第 39 行中，我们用 <code>find</code> 方法查询图片，所有的查询方法可参考 <span class="exturl" data-url="aHR0cHM6Ly9jbi5tb25nb29zZWRvYy50b3AvZG9jcy9xdWVyaWVzLmh0bWw=" title="https://cn.mongoosedoc.top/docs/queries.html">Mongoose 中文文档<i class="fa fa-external-link"></i></span>。<code>find</code> 是查询多条数据记录的通用方法，其四个参数如下：</p><ul><li><code>filter</code>：过滤器，是一个 JavaScript 对象，例如 <code>{ name: 'john' }</code> 则限定返回所有名字为 john 的记录，这里我们用 <code>{}</code> 表示查询所有记录；</li><li><code>projection</code>（可选）：查询所返回的字段，可以是对象或字符串，我们用 <code>{}</code> 表示返回所有字段；</li><li><code>options</code>（可选）：查询操作的选项，用来指定查询操作的一些参数，比如我们用 <code>sort</code> 选项对返回结果进行排序（这里按照发布时间 <code>timestamp</code> 进行倒序排列，即把最新发布的放在最前面）；</li><li><code>callback</code>：回调函数，用于添加在查询完毕时的业务逻辑。</li></ul><p>MongoDB 的查询灵活而强大，但这也意味着一定的学习成本。</p><p>进一步，我们在 image 控制器中添加数据库操作的代码：</p><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    <span class="keyword">const</span> viewModel = &#123;</span><br><span class="line">[tuture-del]      image: &#123;</span><br><span class="line">[tuture-del]        uniqueId: <span class="number">1</span>,</span><br><span class="line">[tuture-del]        title: <span class="string">'示例图片1'</span>,</span><br><span class="line">[tuture-del]        description: <span class="string">'这是张测试图片'</span>,</span><br><span class="line">[tuture-del]        filename: <span class="string">'sample1.jpg'</span>,</span><br><span class="line">[tuture-del]        views: <span class="number">0</span>,</span><br><span class="line">[tuture-del]        likes: <span class="number">0</span>,</span><br><span class="line">[tuture-del]        timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-del]      &#125;,</span><br><span class="line">[tuture-del]      comments: [</span><br><span class="line">[tuture-del]        &#123;</span><br><span class="line">[tuture-del]          image_id: <span class="number">1</span>,</span><br><span class="line">[tuture-del]          email: <span class="string">'test@testing.com'</span>,</span><br><span class="line">[tuture-del]          name: <span class="string">'Test Tester'</span>,</span><br><span class="line">[tuture-del]          comment: <span class="string">'Test 1'</span>,</span><br><span class="line">[tuture-del]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-del]        &#125;,</span><br><span class="line">[tuture-del]        &#123;</span><br><span class="line">[tuture-del]          image_id: <span class="number">1</span>,</span><br><span class="line">[tuture-del]          email: <span class="string">'test@testing.com'</span>,</span><br><span class="line">[tuture-del]          name: <span class="string">'Test Tester'</span>,</span><br><span class="line">[tuture-del]          comment: <span class="string">'Test 2'</span>,</span><br><span class="line">[tuture-del]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-del]        &#125;,</span><br><span class="line">[tuture-del]      ],</span><br><span class="line">[tuture-del]    &#125;;</span><br><span class="line">[tuture-del]    res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> viewModel = &#123; <span class="attr">image</span>: &#123;&#125;, <span class="attr">comments</span>: [] &#125;;</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]    ImageModel.findOne(&#123; <span class="attr">filename</span>: &#123; <span class="attr">$regex</span>: req.params.image_id &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      err,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      image,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]    </span>) </span>&#123;</span><br><span class="line">[tuture-add]      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]      <span class="keyword">if</span> (image) &#123;</span><br><span class="line">[tuture-add]        <span class="comment">// 增加该图片的访问量</span></span><br><span class="line">[tuture-add]        image.views += <span class="number">1</span>;</span><br><span class="line">[tuture-add]        viewModel.image = image;</span><br><span class="line">[tuture-add]        image.save();</span><br><span class="line">[tuture-add]        res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">[tuture-add]      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">[tuture-add]        res.redirect(<span class="string">'/'</span>);</span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tempPath = req.file.path;</span><br><span class="line">[tuture-omit]</span><br><span class="line">    <span class="keyword">if</span> (ext === <span class="string">'.png'</span> || ext === <span class="string">'.jpg'</span> || ext === <span class="string">'.jpeg'</span> || ext === <span class="string">'.gif'</span>) &#123;</span><br><span class="line">      fs.rename(tempPath, targetPath, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-del]        res.redirect(<span class="string">'/images/'</span> + imgUrl);</span><br><span class="line">[tuture-add]        <span class="keyword">const</span> newImg = <span class="keyword">new</span> ImageModel(&#123;</span><br><span class="line">[tuture-add]          title: req.body.title,</span><br><span class="line">[tuture-add]          description: req.body.description,</span><br><span class="line">[tuture-add]          filename: imgUrl + ext,</span><br><span class="line">[tuture-add]        &#125;);</span><br><span class="line">[tuture-add]        newImg.save(<span class="function"><span class="keyword">function</span>(<span class="params">err, image</span>) </span>&#123;</span><br><span class="line">[tuture-add]          <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]          res.redirect(<span class="string">'/images/'</span> + image.uniqueId);</span><br><span class="line">[tuture-add]        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fs.unlink(tempPath, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br></pre></td></tr></table></figure><p>在 <code>image.index</code> 和 <code>image.create</code> 两个控制器中，我们分别进行了单条数据记录的查询和插入。<code>findOne</code> 与之前的 <code>find</code> 参数格式完全一致，只不过仅返回一条数据。在插入新数据时，先创建一个 <code>ImageModel</code> 实例，然后再调用 <code>save</code> 方法进行保存即可。</p><p>最后，我们需要在服务器刚刚运行时就连接好数据库，因此在 server.js 中添加如下代码：</p><figure class="highlight js"><figcaption><span>server.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> configure = <span class="built_in">require</span>(<span class="string">'./server/configure'</span>);</span><br><span class="line"></span><br><span class="line">app = express();</span><br><span class="line">app = configure(app);</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]<span class="comment">// 建立数据库连接</span></span><br><span class="line">[tuture-add]mongoose.connect(<span class="string">'mongodb://localhost/instagrammy'</span>);</span><br><span class="line">[tuture-add]mongoose.connection.on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">[tuture-add]  <span class="built_in">console</span>.log(<span class="string">'Mongoose connected.'</span>);</span><br><span class="line">[tuture-add]&#125;);</span><br><span class="line">[tuture-add]</span><br><span class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br></pre></td></tr></table></figure><p>到了这一步，我们运行 <code>node server.js</code> 运行服务器（确保 MongoDB 数据库已经在运行！），尝试上传图片，可以发现不仅能上传成功，还可以在首页看到新添加的图片了！</p><h2 id="实现评论功能"><a href="#实现评论功能" class="headerlink" title="实现评论功能"></a>实现评论功能</h2><p>类似地，我们进一步实现网站的评论功能。按照 MVC 模式，我们将依次实现评论的模型（M）、视图（V）和控制器（C）。</p><p>首先，仿照 models/image.js，我们实现评论的数据模型：</p><figure class="highlight js"><figcaption><span>models/comment.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Schema = mongoose.Schema;</span><br><span class="line"><span class="keyword">const</span> ObjectId = Schema.ObjectId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> CommentSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">  image_id: &#123; <span class="attr">type</span>: ObjectId &#125;,</span><br><span class="line">  email: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  gravatar: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  comment: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  timestamp: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">CommentSchema.virtual(<span class="string">'image'</span>)</span><br><span class="line">  .set(<span class="function"><span class="keyword">function</span>(<span class="params">image</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._image = image;</span><br><span class="line">  &#125;)</span><br><span class="line">  .get(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._image;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = mongoose.model(<span class="string">'Comment'</span>, CommentSchema);</span><br></pre></td></tr></table></figure><p><code>CommentSchema</code> 有两个字段需要补充说明一下：</p><ul><li><code>image_id</code>：由于图片和评论是一对多的关系（即一张图片包括多个评论），因此我们需要在记录每个评论所属的图片，即通过 <code>image_id</code> 字段进行记录；</li><li><code>gravatar</code>：用 MD5 对电子邮箱加密后得到的字符串，用于访问 <span class="exturl" data-url="aHR0cHM6Ly9ncmF2YXRhci5jb20=" title="https://gravatar.com">Gravatar<i class="fa fa-external-link"></i></span> 服务。Gravatar 提供了跨网站的头像服务，如果你在集成了 Gravatar 服务的网站通过邮箱注册并上传了头像，那么别的网站也可以通过 Gravatar 访问你的头像。这里请通过 <code>npm install md5</code> 安装 MD5 加密的包。</li></ul><p>我们对评论有关的界面代码进行细微的调整，将提交按钮的 <code>type</code> 从 <code>button</code> 改为 <code>submit</code>：</p><figure class="highlight handlebars"><figcaption><span>views/image.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-sm-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12 text-right"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-del]              <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">id</span>=<span class="string">"comment-btn"</span> <span class="attr">type</span>=<span class="string">"button"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]              <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">id</span>=<span class="string">"comment-btn"</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-comment"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 发表</span></span><br><span class="line"><span class="xml">              <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>最后是评论有关的 controller 代码。包括在 <code>image.comment</code> 中实现创建评论，以及在 <code>image.index</code> 中实现对单张图片所有评论的查询：</p><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">'md5'</span>);</span><br><span class="line"><span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> CommentModel = <span class="built_in">require</span>(<span class="string">'../models/comment'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-omit]</span><br><span class="line">        image.views += <span class="number">1</span>;</span><br><span class="line">        viewModel.image = image;</span><br><span class="line">        image.save();</span><br><span class="line">[tuture-del]        res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]        CommentModel.find(</span><br><span class="line">[tuture-add]          &#123; <span class="attr">image_id</span>: image._id &#125;,</span><br><span class="line">[tuture-add]          &#123;&#125;,</span><br><span class="line">[tuture-add]          &#123; <span class="attr">sort</span>: &#123; <span class="attr">timestamp</span>: <span class="number">1</span> &#125; &#125;,</span><br><span class="line">[tuture-add]          <span class="function"><span class="keyword">function</span>(<span class="params">err, comments</span>) </span>&#123;</span><br><span class="line">[tuture-add]            <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]            viewModel.comments = comments;</span><br><span class="line">[tuture-add]            res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">[tuture-add]          &#125;,</span><br><span class="line">[tuture-add]        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.redirect(<span class="string">'/'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">[tuture-omit]</span><br><span class="line">    res.send(<span class="string">'The image:like POST controller'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  comment: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    res.send(<span class="string">'The image:comment POST controller'</span>);</span><br><span class="line">[tuture-add]    ImageModel.findOne(&#123; <span class="attr">filename</span>: &#123; <span class="attr">$regex</span>: req.params.image_id &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      err,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      image,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]    </span>) </span>&#123;</span><br><span class="line">[tuture-add]      <span class="keyword">if</span> (!err &amp;&amp; image) &#123;</span><br><span class="line">[tuture-add]        <span class="keyword">const</span> newComment = <span class="keyword">new</span> CommentModel(req.body);</span><br><span class="line">[tuture-add]        newComment.gravatar = md5(newComment.email);</span><br><span class="line">[tuture-add]        newComment.image_id = image._id;</span><br><span class="line">[tuture-add]        newComment.save(<span class="function"><span class="keyword">function</span>(<span class="params">err, comment</span>) </span>&#123;</span><br><span class="line">[tuture-add]          <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]          res.redirect(<span class="string">'/images/'</span> + image.uniqueId + <span class="string">'#'</span> + comment._id);</span><br><span class="line">[tuture-add]        &#125;);</span><br><span class="line">[tuture-add]      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">[tuture-add]        res.redirect(<span class="string">'/'</span>);</span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>查询与创建评论的代码和之前操作图片的代码大部分都是一致的，最大的差别在于查询时需要根据所属的图片 ID，创建时需要记录图片的 ID。这里我们约定使用 MongoDB 为每一条数据默认创建的 <code>_id</code> 字段。</p><h2 id="实现图片的点赞和删除"><a href="#实现图片的点赞和删除" class="headerlink" title="实现图片的点赞和删除"></a>实现图片的点赞和删除</h2><p>这一步中，我们将实现图片的点赞和删除。</p><p>首先在控制器中添加点赞和删除的代码：</p><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  like: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    res.send(<span class="string">'The image:like POST controller'</span>);</span><br><span class="line">[tuture-add]    ImageModel.findOne(&#123; <span class="attr">filename</span>: &#123; <span class="attr">$regex</span>: req.params.image_id &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      err,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      image,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]    </span>) </span>&#123;</span><br><span class="line">[tuture-add]      <span class="keyword">if</span> (!err &amp;&amp; image) &#123;</span><br><span class="line">[tuture-add]        image.likes += <span class="number">1</span>;</span><br><span class="line">[tuture-add]        image.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">[tuture-add]          <span class="keyword">if</span> (err) res.json(err);</span><br><span class="line">[tuture-add]          <span class="keyword">else</span> res.json(&#123; <span class="attr">likes</span>: image.likes &#125;);</span><br><span class="line">[tuture-add]        &#125;);</span><br><span class="line">[tuture-add]      &#125;</span><br><span class="line">[tuture-add]    &#125;);</span><br><span class="line">[tuture-add]  &#125;,</span><br><span class="line">[tuture-add]  remove: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-add]    ImageModel.findOne(&#123; <span class="attr">filename</span>: &#123; <span class="attr">$regex</span>: req.params.image_id &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      err,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      image,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]    </span>) </span>&#123;</span><br><span class="line">[tuture-add]      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]      fs.unlink(path.resolve(<span class="string">'./public/upload/'</span> + image.filename), <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]        err,</span></span></span><br><span class="line"><span class="function"><span class="params">[tuture-add]      </span>) </span>&#123;</span><br><span class="line">[tuture-add]        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">[tuture-add]        CommentModel.remove(&#123; <span class="attr">image_id</span>: image._id &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">[tuture-add]          image.remove(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">[tuture-add]            <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">[tuture-add]              res.json(<span class="literal">true</span>);</span><br><span class="line">[tuture-add]            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">[tuture-add]              res.json(<span class="literal">false</span>);</span><br><span class="line">[tuture-add]            &#125;</span><br><span class="line">[tuture-add]          &#125;);</span><br><span class="line">[tuture-add]        &#125;);</span><br><span class="line">[tuture-add]      &#125;);</span><br><span class="line">[tuture-add]    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  comment: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    ImageModel.findOne(&#123; <span class="attr">filename</span>: &#123; <span class="attr">$regex</span>: req.params.image_id &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br></pre></td></tr></table></figure><p>在两个控制器中，我们都按照<strong><em>查询-&gt;修改-&gt;保存</em></strong>的流程进行操作。不过在删除图片中，我们不仅先删除上传图片，再删除了此图片所有的评论模型，最后再删除数据库中的图片模型，这一切通过 <code>Model.remove</code> 方法都可以轻松实现。<code>remove</code> 的使用方法与之前的 <code>find</code> 几乎一模一样，只不过 <code>find</code> 会返回符合条件的结果，而 <code>remove</code> 则会直接将符合条件的记录从数据库中删除。</p><p>我们在路由模块 server/routes.js 中添加刚刚写好的 <code>image.remove</code> 控制器：</p><figure class="highlight js"><figcaption><span>server/routes.js</span></figcaption><table><tr><td class="code"><pre><span class="line">  router.post(<span class="string">'/images'</span>, upload.single(<span class="string">'file'</span>), image.create);</span><br><span class="line">  router.post(<span class="string">'/images/:image_id/like'</span>, image.like);</span><br><span class="line">  router.post(<span class="string">'/images/:image_id/comment'</span>, image.comment);</span><br><span class="line">[tuture-add]  router.delete(<span class="string">'/images/:image_id'</span>, image.remove);</span><br><span class="line">  app.use(router);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>如果你尝试运行网站，你会发现点击点赞和删除按钮并没有什么用。因此，我们选用 jQuery 来实现前端界面向服务器发起点赞和删除的请求。在布局文件中添加 jQuery 的静态链接，以及相应的 jQuery 代码（如果不熟悉 jQuery 也不必过于纠结，直接复制粘贴就行了）：</p><figure class="highlight handlebars"><figcaption><span>views/layouts/main.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  $(function () &#123;</span></span><br><span class="line"><span class="xml">[tuture-add]    // to do...</span></span><br><span class="line"><span class="xml">[tuture-add]  &#125;);</span></span><br><span class="line"><span class="xml">[tuture-add]</span></span><br><span class="line"><span class="xml">[tuture-add]  $('#btn-like').on('click', function (event) &#123;</span></span><br><span class="line"><span class="xml">[tuture-add]    event.preventDefault();</span></span><br><span class="line"><span class="xml">[tuture-add]    var imgId = $(this).data('id');</span></span><br><span class="line"><span class="xml">[tuture-add]    $.post('/images/' + imgId + '/like').done(function (data) &#123;</span></span><br><span class="line"><span class="xml">[tuture-add]      $('.likes-count').text(data.likes);</span></span><br><span class="line"><span class="xml">[tuture-add]    &#125;);</span></span><br><span class="line"><span class="xml">[tuture-add]  &#125;);</span></span><br><span class="line"><span class="xml">[tuture-add]</span></span><br><span class="line"><span class="xml">[tuture-add]  $('#btn-delete').on('click', function (event) &#123;</span></span><br><span class="line"><span class="xml">[tuture-add]    event.preventDefault();</span></span><br><span class="line"><span class="xml">[tuture-add]    var $this = $(this);</span></span><br><span class="line"><span class="xml">[tuture-add]</span></span><br><span class="line"><span class="xml">[tuture-add]    var remove = confirm('确定要删除这张图片吗?');</span></span><br><span class="line"><span class="xml">[tuture-add]    if (remove) &#123;</span></span><br><span class="line"><span class="xml">[tuture-add]      var imgId = $(this).data('id');</span></span><br><span class="line"><span class="xml">[tuture-add]      $</span></span><br><span class="line"><span class="xml">[tuture-add]        .ajax(&#123;</span></span><br><span class="line"><span class="xml">[tuture-add]          url: '/images/' + imgId,</span></span><br><span class="line"><span class="xml">[tuture-add]          type: 'DELETE'</span></span><br><span class="line"><span class="xml">[tuture-add]        &#125;)</span></span><br><span class="line"><span class="xml">[tuture-add]        .done(function (result) &#123;</span></span><br><span class="line"><span class="xml">[tuture-add]          if (result) &#123;</span></span><br><span class="line"><span class="xml">[tuture-add]            $this.removeClass('btn-danger').addClass('btn-success');</span></span><br><span class="line"><span class="xml">[tuture-add]            $this.find('i').removeClass('fa-times').addClass('fa-check');</span></span><br><span class="line"><span class="xml">[tuture-add]            $this.append('<span class="tag">&lt;<span class="name">span</span>&gt;</span> 已删除!<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span><br><span class="line"><span class="xml">[tuture-add]          &#125;</span></span><br><span class="line"><span class="xml">[tuture-add]        &#125;);</span></span><br><span class="line"><span class="xml">[tuture-add]    &#125;</span></span><br><span class="line"><span class="xml">[tuture-add]  &#125;);</span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>再尝试运行网站，可以看到点赞和删除功能都已经实现了！只不过侧边栏的所有数据都没有同步更新，我们将在下一步中进行完善。</p><h2 id="完善用户界面"><a href="#完善用户界面" class="headerlink" title="完善用户界面"></a>完善用户界面</h2><p>终于来到教程的最后一步！我们将实现侧边栏中所有容器（统计数据、最受欢迎图片和最新评论）的数据同步。先创建 helpers 目录，用于存放侧边栏数据获取的相关代码。然后分析一下数据同步逻辑（例如统计数据），我们发现要进行的查询非常多：图片总数、评论总数、图片所有的访问量、图片所有的点赞数。如果按照普通的写法，我们也许会这样写：</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">queryA(<span class="function"><span class="keyword">function</span>(<span class="params">err, resultsA</span>) </span>&#123;</span><br><span class="line">  queryB(<span class="function"><span class="keyword">function</span>(<span class="params">err, resultsB</span>) </span>&#123;</span><br><span class="line">    queryC(<span class="function"><span class="keyword">function</span>(<span class="params">err, resultsC</span>) </span>&#123;</span><br><span class="line">      queryD(<span class="function"><span class="keyword">function</span>(<span class="params">err, resultsD</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// some code ...</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样的代码不仅十分丑陋，难以维护（即大家常说的“回调地狱”），而且性能也十分糟糕——所有查询都是链式执行。但其实所有的查询都是相互独立的，完全可以并发进行，那我们应该怎么写呢？</p><p>答案就是 <span class="exturl" data-url="aHR0cDovL2Nhb2xhbi5naXRodWIuaW8vYXN5bmMv" title="http://caolan.github.io/async/">async<i class="fa fa-external-link"></i></span> 库。async 是在 ECMAScript 6 的 Promise 体系出现之前最流行的异步组件库，凭借其强大的性能、丰富且设计良好的接口成为 Node 和前端开发中解决异步的最佳选择之一。这里我们也用 async 来解决并发获取数据的问题。安装 async 包：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install async</span><br></pre></td></tr></table></figure><p>然后创建 helpers/stats.js，用于获取网站统计数据：</p><figure class="highlight js"><figcaption><span>helpers/stats.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"><span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line"><span class="keyword">const</span> CommentModel = <span class="built_in">require</span>(<span class="string">'../models/comment'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">async</span>.parallel(</span><br><span class="line">    [</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 统计图片总数</span></span><br><span class="line">        ImageModel.count(&#123;&#125;, next);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 统计评论总数</span></span><br><span class="line">        CommentModel.count(&#123;&#125;, next);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 对图片所有访问量求和</span></span><br><span class="line">        ImageModel.aggregate(</span><br><span class="line">          [</span><br><span class="line">            &#123;</span><br><span class="line">              $group: &#123;</span><br><span class="line">                _id: <span class="string">'1'</span>,</span><br><span class="line">                viewsTotal: &#123; <span class="attr">$sum</span>: <span class="string">'$views'</span> &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">          <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              <span class="keyword">return</span> next(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> viewsTotal = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (result.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              viewsTotal += result[<span class="number">0</span>].viewsTotal;</span><br><span class="line">            &#125;</span><br><span class="line">            next(<span class="literal">null</span>, viewsTotal);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 对所有点赞数求和</span></span><br><span class="line">        ImageModel.aggregate(</span><br><span class="line">          [</span><br><span class="line">            &#123;</span><br><span class="line">              $group: &#123;</span><br><span class="line">                _id: <span class="string">'1'</span>,</span><br><span class="line">                likesTotal: &#123; <span class="attr">$sum</span>: <span class="string">'$likes'</span> &#125;,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">          <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              <span class="keyword">return</span> next(err);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> likesTotal = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (result.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              likesTotal += result[<span class="number">0</span>].likesTotal;</span><br><span class="line">            &#125;</span><br><span class="line">            next(<span class="literal">null</span>, likesTotal);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">      callback(<span class="literal">null</span>, &#123;</span><br><span class="line">        images: results[<span class="number">0</span>],</span><br><span class="line">        comments: results[<span class="number">1</span>],</span><br><span class="line">        views: results[<span class="number">2</span>],</span><br><span class="line">        likes: results[<span class="number">3</span>],</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这里我们用到了 <code>async.parallel</code> 接口，它接受两个参数：</p><ul><li><code>tasks</code>：一个函数数组，每个函数对应一个异步任务（所有任务将并发执行），并且接受一个回调函数用于返回任务执行的结果；</li><li><code>callback</code>：整个任务组的回调函数，可以获取所有异步任务执行完成后的所有结果。</li></ul><p>我们将四个数据查询任务包装成四个函数作为 <code>async.parallel</code> 的第一个参数，在最后的 <code>callback</code> 中返回所有查询结果。非常简洁、优雅。</p><p>接下来实现侧边栏中的最新图片模块，一个简单的数据库查询即可：</p><figure class="highlight js"><figcaption><span>helpers/images.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  popular: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    ImageModel.find(&#123;&#125;, &#123;&#125;, &#123; <span class="attr">limit</span>: <span class="number">9</span>, <span class="attr">sort</span>: &#123; <span class="attr">likes</span>: <span class="number">-1</span> &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      err,</span></span></span><br><span class="line"><span class="function"><span class="params">      images,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">      callback(<span class="literal">null</span>, images);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>然后是创建获取最新评论的代码。不过简单地查询评论模型是不够的，我们还需要获取到每个评论对应的图片，这时候用 <code>async.each</code> 函数对一个数组中所有对象进行异步操作最为合适不过。整个模块的代码如下：</p><figure class="highlight js"><figcaption><span>helpers/comments.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"><span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line"><span class="keyword">const</span> CommentModel = <span class="built_in">require</span>(<span class="string">'../models/comment'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  newest: <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    CommentModel.find(&#123;&#125;, &#123;&#125;, &#123; <span class="attr">limit</span>: <span class="number">5</span>, <span class="attr">sort</span>: &#123; <span class="attr">timestamp</span>: <span class="number">-1</span> &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      err,</span></span></span><br><span class="line"><span class="function"><span class="params">      comments,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> callback(err);</span><br><span class="line">      <span class="keyword">var</span> attachImage = <span class="function"><span class="keyword">function</span>(<span class="params">comment, next</span>) </span>&#123;</span><br><span class="line">        ImageModel.findOne(&#123; <span class="attr">_id</span>: comment.image_id &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, image</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">          comment.image = image;</span><br><span class="line">          next(err);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">async</span>.each(comments, attachImage, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">        callback(err, comments);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>async.each</code> 函数接受的三个参数如下：</p><ul><li><code>collection</code>：用于接收异步操作的集合，这里是评论集；</li><li><code>iteratee</code>：异步操作函数，这里是 <code>attachImage</code> 函数；</li><li><code>callback</code>：全部操作执行完成的回调函数。</li></ul><p>我们将前面三个 helper 函数放到一起，创建一个 sidebar 模块，并发获取三个模块的数据。这里我们还是用 <code>async.parallel</code> 函数，因为三个模块本质上也是异步查询：</p><figure class="highlight js"><figcaption><span>helpers/sidebar.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">async</span> = <span class="built_in">require</span>(<span class="string">'async'</span>);</span><br><span class="line"><span class="keyword">const</span> Stats = <span class="built_in">require</span>(<span class="string">'./stats'</span>);</span><br><span class="line"><span class="keyword">const</span> Images = <span class="built_in">require</span>(<span class="string">'./images'</span>);</span><br><span class="line"><span class="keyword">const</span> Comments = <span class="built_in">require</span>(<span class="string">'./comments'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">viewModel, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">async</span>.parallel(</span><br><span class="line">    [</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        Stats(next);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        Images.popular(next);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        Comments.newest(next);</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err, results</span>) </span>&#123;</span><br><span class="line">      viewModel.sidebar = &#123;</span><br><span class="line">        stats: results[<span class="number">0</span>],</span><br><span class="line">        popular: results[<span class="number">1</span>],</span><br><span class="line">        comments: results[<span class="number">2</span>],</span><br><span class="line">      &#125;;</span><br><span class="line">      callback(viewModel);</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>并发的异步操作层层嵌套，是不是很炫酷呢？</p><p>最后将我们炫酷的 sidebar 模块用到 home 和 image 控制器中：</p><figure class="highlight js"><figcaption><span>controllers/home.js</span></figcaption><table><tr><td class="code"><pre><span class="line">[tuture-add]<span class="keyword">const</span> sidebar = <span class="built_in">require</span>(<span class="string">'../helpers/sidebar'</span>);</span><br><span class="line"><span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">[tuture-omit]</span><br><span class="line">    ImageModel.find(&#123;&#125;, &#123;&#125;, &#123; <span class="attr">sort</span>: &#123; <span class="attr">timestamp</span>: <span class="number">-1</span> &#125; &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, images</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      viewModel.images = images;</span><br><span class="line">[tuture-del]      res.render(<span class="string">'index'</span>, viewModel);</span><br><span class="line">[tuture-add]      sidebar(viewModel, <span class="function"><span class="keyword">function</span>(<span class="params">viewModel</span>) </span>&#123;</span><br><span class="line">[tuture-add]        res.render(<span class="string">'index'</span>, viewModel);</span><br><span class="line">[tuture-add]      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">'md5'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> sidebar = <span class="built_in">require</span>(<span class="string">'../helpers/sidebar'</span>);</span><br><span class="line"><span class="keyword">const</span> ImageModel = <span class="built_in">require</span>(<span class="string">'../models/image'</span>);</span><br><span class="line"><span class="keyword">const</span> CommentModel = <span class="built_in">require</span>(<span class="string">'../models/comment'</span>);</span><br><span class="line"></span><br><span class="line">[tuture-omit]</span><br><span class="line">          <span class="function"><span class="keyword">function</span>(<span class="params">err, comments</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">            viewModel.comments = comments;</span><br><span class="line">[tuture-del]            res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">[tuture-add]            sidebar(viewModel, <span class="function"><span class="keyword">function</span>(<span class="params">viewModel</span>) </span>&#123;</span><br><span class="line">[tuture-add]              res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">[tuture-add]            &#125;);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br></pre></td></tr></table></figure><p>侧边栏的所有数据都能够同步更新，我们的网站也基本完成了！</p>]]></content>
    
    <summary type="html">
    
      在本系列教程的第二部分中，我们将接入 MongoDB 数据库，并由此实现围绕图片、评论的功能。
    
    </summary>
    
    
    
      <category term="Node" scheme="https://tuture.co/tags/Node/"/>
    
      <category term="MongoDB" scheme="https://tuture.co/tags/MongoDB/"/>
    
      <category term="Express" scheme="https://tuture.co/tags/Express/"/>
    
  </entry>
  
  <entry>
    <title>从零开始用 Express + MongoDB 搭建图片分享社区（一）</title>
    <link href="https://tuture.co/2019/10/16/a0531f0/"/>
    <id>https://tuture.co/2019/10/16/a0531f0/</id>
    <published>2019-10-16T00:00:00.509Z</published>
    <updated>2019-10-16T02:52:55.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="初始化项目结构"><a href="#初始化项目结构" class="headerlink" title="初始化项目结构"></a>初始化项目结构</h2><p>首先我们创建项目目录，并初始化 npm：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir Instagrammy &amp;&amp; <span class="built_in">cd</span> Instagrammy</span><br><span class="line">$ npm init</span><br></pre></td></tr></table></figure><a id="more"></a><p>添加 express 的项目依赖：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install express</span><br></pre></td></tr></table></figure><p>最终生成的 package.json 文件如下：</p><figure class="highlight json"><figcaption><span>package.json</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"instagrammy"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"keywords"</span>: [],</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"express"</span>: <span class="string">"^4.17.1"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后编写服务器的入口文件 <code>server.js</code>，内容如下：</p><figure class="highlight js"><figcaption><span>server.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line">app = express();</span><br><span class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'Hello World!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server is running on http://localhost:<span class="subst">$&#123;app.get(<span class="string">'port'</span>)&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>通过 <code>node server.js</code> 运行 server.js 文件，然后在浏览器中访问 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDozMDAw" title="http://localhost:3000">http://localhost:3000<i class="fa fa-external-link"></i></span>，便可以看到服务器的返回的 Hello World：</p><p><img alt data-src="./figure-1.png"></p><h2 id="配置中间件"><a href="#配置中间件" class="headerlink" title="配置中间件"></a>配置中间件</h2><p>Express 本身是一个非常简洁的 web 框架，但是通过中间件这一设计模式，能够实现非常丰富的功能。一个 Express 中间件本质上是一个函数：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">someMiddleware</span>(<span class="params">req, res, next</span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p><code>req</code> 参数是一个 <code>express.Request</code> 对象，封装了用户请求；<code>res</code> 参数则是一个 <code>express.Response</code> 对象，封装了即将返回给用户的响应；<code>next</code> 则是在执行完所有逻辑后用于触发下一个中间件的函数。</p><p>添加中间件的代码则非常简单：</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.use(middlewareA);</span><br><span class="line">app.use(middlewareB);</span><br><span class="line">app.use(middlewareC);</span><br></pre></td></tr></table></figure><p>中间件 A、B、C 将会在处理每次请求时<strong><em>按顺序执行</em></strong>（这也意味着中间件的顺序是非常重要的）。接下来我们将添加以下基础中间件（也是几乎所有应用都会用到的中间件）：</p><ul><li><code>morgan</code>：用于记录日志的中间件，对于开发调试和生产监控都很有用；</li><li><code>bodyParser</code>：用于解析客户端请求的中间件，包括 HTML 表单和 JSON 请求；</li><li><code>methodOverride</code>：为老的浏览器提供 REST 请求的兼容性支持；</li><li><code>cookieParser</code>：用于收发 cookie；</li><li><code>errorHandler</code>：用于在发生错误时打印调用栈，<strong><em>仅在开发时使用</em></strong>；</li><li><code>handlebars</code>：用于渲染用户界面的模板引擎，会在后面细讲。</li></ul><p>我们通过 npm 安装这些中间件：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install express-handlebars body-parser cookie-parser morgan method-override errorhandler</span><br></pre></td></tr></table></figure><p>创建 server 目录，在其中添加 configure.js 模块，用于配置所有的中间件：</p><figure class="highlight js"><figcaption><span>server/configure.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> exphbs = <span class="built_in">require</span>(<span class="string">'express-handlebars'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">const</span> methodOverride = <span class="built_in">require</span>(<span class="string">'method-override'</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">'errorhandler'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.use(morgan(<span class="string">'dev'</span>));</span><br><span class="line">  app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">  app.use(bodyParser.json());</span><br><span class="line">  app.use(methodOverride());</span><br><span class="line">  app.use(cookieParser(<span class="string">'secret-value'</span>));</span><br><span class="line">  app.use(<span class="string">'/public/'</span>, express.static(path.join(__dirname, <span class="string">'../public'</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (app.get(<span class="string">'env'</span>) === <span class="string">'development'</span>) &#123;</span><br><span class="line">    app.use(errorHandler());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>值得一提的是，除了上面提到的中间件，我们还用到了 express 自带的静态资源中间件 <code>express.static</code>，用于向客户端发送图片、CSS等静态文件。最后，我们通过获取 <code>env</code> 变量来判断是否处于开发环境，如果是的话就添加 <code>errorHandler</code> 以便于调试代码。</p><p>在 server.js 中调用刚才用于配置中间件的代码：</p><figure class="highlight js"><figcaption><span>server.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> configure = <span class="built_in">require</span>(<span class="string">'./server/configure'</span>);</span><br><span class="line"></span><br><span class="line">app = express();</span><br><span class="line">[tuture-add]app = configure(app);</span><br><span class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br></pre></td></tr></table></figure><h2 id="搭建路由和控制器"><a href="#搭建路由和控制器" class="headerlink" title="搭建路由和控制器"></a>搭建路由和控制器</h2><p>现在我们已经配置好了基础的中间件，但是只有主页（URL 为 <code>/</code>）可以访问。接下来我们将实现以下路由：</p><ul><li><code>GET /</code>：网站主页</li><li><code>GET /images/image_id</code>：展示单张图片</li><li><code>POST /images</code>：上传图片</li><li><code>POST /images/image_id/like</code>：点赞图片</li><li><code>POST /images/image_id/comment</code>：评论图片</li></ul><p>虽然 Express 的项目结构没有固定的套路，但是我们将采用经典的 MVC 模式（即 Model View Controller）来搭建我们的项目。Model 定义了数据模型，View 定义了用户界面，而 Controller 则定义了相应的业务逻辑。</p><p>首先创建 controllers 目录，在其中创建 home.js 文件，并定义 <code>index</code> 控制器如下：</p><figure class="highlight js"><figcaption><span>controllers/home.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The home:index controller'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>每个控制器实际上都是一个 Express 中间件（只不过不需要 <code>next</code> 函数，因为是最后一个中间件）。这里我们暂时用 <code>res.send</code> 发一条文字来代表这个 controller 已经实现。</p><p>再在 controllers 目录下创建 image.js，实现与图片处理相关的控制器：</p><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The image:index controller '</span> + req.params.image_id);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The image:create POST controller'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  like: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The image:like POST controller'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  comment: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The image:comment POST controller'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>然后在 server 目录下创建路由模块 routes.js，建立从 URL 到控制器之间的映射：</p><figure class="highlight js"><figcaption><span>server/routes.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="keyword">const</span> home = <span class="built_in">require</span>(<span class="string">'../controllers/home'</span>);</span><br><span class="line"><span class="keyword">const</span> image = <span class="built_in">require</span>(<span class="string">'../controllers/image'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">  router.get(<span class="string">'/'</span>, home.index);</span><br><span class="line">  router.get(<span class="string">'/images/:image_id'</span>, image.index);</span><br><span class="line">  router.post(<span class="string">'/images'</span>, image.create);</span><br><span class="line">  router.post(<span class="string">'/images/:image_id/like'</span>, image.like);</span><br><span class="line">  router.post(<span class="string">'/images/:image_id/comment'</span>, image.comment);</span><br><span class="line">  app.use(router);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这里我们用到了 Express 自带的路由类 <code>Router</code>，可以很方便地定义路由，并且 <code>Router</code> 本身也是一个中间件，可以直接通过 <code>app.use</code> 进行配置。</p><p>接着在 server/configure.js 模块中调用路由模块。</p><figure class="highlight js"><figcaption><span>server/configure.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> methodOverride = <span class="built_in">require</span>(<span class="string">'method-override'</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">'errorhandler'</span>);</span><br><span class="line"></span><br><span class="line">[tuture-add]<span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br><span class="line">[tuture-add]</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">  app.use(morgan(<span class="string">'dev'</span>));</span><br><span class="line">  app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">[tuture-omit]</span><br><span class="line">    app.use(errorHandler());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">[tuture-add]  routes(app);</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>最后我们去掉 server.js 中原来的首页路由。</p><figure class="highlight js"><figcaption><span>server.js</span></figcaption><table><tr><td class="code"><pre><span class="line">app = configure(app);</span><br><span class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">[tuture-del]app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]  res.send(<span class="string">'Hello World!'</span>);</span><br><span class="line">[tuture-del]&#125;);</span><br><span class="line">[tuture-del]</span><br><span class="line">app.listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Server is running on http://localhost:<span class="subst">$&#123;app.get(<span class="string">'port'</span>)&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>到了这一步，我们运行服务器，打开浏览器访问 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDozMDAw" title="http://localhost:3000">http://localhost:3000<i class="fa fa-external-link"></i></span>，可以看到 <code>The home:index controller</code> 的信息；访问 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDozMDAwL3Rlc3QxMjM=" title="http://localhost:3000/test123">http://localhost:3000/test123<i class="fa fa-external-link"></i></span>，则是 <code>The image:index controller test123</code>。进一步，我们还可以通过 Postman 或者 curl 等工具测试 POST 方法的 controller 是否可用。下面以 curl 为例测试 <code>POST /images</code>：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -X POST localhost:3000/images</span><br><span class="line">The image:create POST controller</span><br></pre></td></tr></table></figure><p>一切顺利！到这里可以泡杯茶好好犒劳一下自己了~</p><h2 id="配置-handlebars-模板引擎"><a href="#配置-handlebars-模板引擎" class="headerlink" title="配置 handlebars 模板引擎"></a>配置 handlebars 模板引擎</h2><p>这一步，我们将开始实现 MVC 中的 V，即 View，用户界面。</p><p>首页的效果如下图所示：</p><p><img alt data-src="./figure-2.png"></p><p>图片详情的效果如下图所示：</p><p><img alt data-src="./figure-3.png"></p><p>尽管如今前后端分离已经是大势所趋，但是通过模板引擎在服务器端渲染页面也是有用武之地的，特别是快速地开发一些简单的应用。在模板引擎中，<span class="exturl" data-url="aHR0cDovL2hhbmRsZWJhcnNqcy5jb20v" title="http://handlebarsjs.com/">Handlebars<i class="fa fa-external-link"></i></span> 和 <span class="exturl" data-url="aHR0cHM6Ly9wdWdqcy5vcmcvYXBpL2dldHRpbmctc3RhcnRlZC5odG1s" title="https://pugjs.org/api/getting-started.html">Pug<i class="fa fa-external-link"></i></span> 当属其中的佼佼者。由于 Handlebars 和普通的 HTML 文档几乎完全一致，容易上手，因此这篇教程中我们选用 Handlebars，并且选用 Bootstrap 样式。</p><p>与普通的 HTML 文档相比，模板最大的特点即在于提供了数据的接入。例如 handlebars，可以在双花括号 <code>{{}}</code> 之间填写任何数据，当服务器渲染页面时只需传入相应的数据即可渲染成对应的内容。除此之外，handlebars 还支持条件语法、循环语法和模板嵌套等高级功能，下面将详细描述。</p><p>我们创建一个 views 目录，用于存放所有的模板代码。views 目录的结构如下所示：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">views</span><br><span class="line">├── image.handlebars</span><br><span class="line">├── index.handlebars</span><br><span class="line">├── layouts</span><br><span class="line">│   └── main.handlebars</span><br><span class="line">└── partials</span><br><span class="line">    ├── comments.handlebars</span><br><span class="line">    ├── popular.handlebars</span><br><span class="line">    └── stats.handlebars</span><br></pre></td></tr></table></figure><p>其中 image.handlebars 和 index.handlebars 是<strong><em>页面模板</em></strong>，layouts/main.handlebars 则是整个网站的<strong><em>布局模板</em></strong>（所有页面共享），partials 目录则用于存放页面之间共享的<strong><em>组件模板</em></strong>，例如评论、数据等等。</p><p>首先完成布局模板 layouts/main.handlebars：</p><figure class="highlight handlebars"><figcaption><span>views/layouts/main.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE html&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Instagrammy<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"page-header"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>Instagrammy<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8"</span>&gt;</span></span><span class="template-variable">&#123;&#123;&#123;body&#125;&#125;</span><span class="xml">&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>main.handlebars 本身是一个完整的 HTML 文档，包括 <code>head</code> 和 <code>body</code> 部分。在 <code>head</code> 部分，我们定义了网站的一些元数据，还加入了 Bootstrap 的 CDN 链接；在 <code>body</code> 部分，包含两个容器：网站头部（header）和每个页面的自定义内容（即<code>{{{body}}}</code> ）。</p><p>接下来编写 index.handlebars，即主页内容。这里我们暂时先写上一个大标题：</p><figure class="highlight handlebars"><figcaption><span>views/index.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Index Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>还有 image.handlebars，即图片详情页面内容：</p><figure class="highlight handlebars"><figcaption><span>views/image.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Image Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>index.handlebars 和 image.handlebars 的内容将替换布局模板中的 <code>{{{body}}}</code> 部分。在用户访问某个页面时，页面内容 = <strong><em>布局模板+页面模板</em></strong>。</p><p>模板写好之后，我们修改控制器相应的代码，通过 <code>res.render</code> 函数渲染模板：</p><figure class="highlight js"><figcaption><span>controllers/home.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    res.send(<span class="string">'The home:index controller'</span>);</span><br><span class="line">[tuture-add]    res.render(<span class="string">'index'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>render</code> 函数接受一个字符串参数，即页面模板的名称。例如 <code>index.handlebars</code> 的名称即为 <code>index</code>。</p><p>同样地，我们修改 image 控制器的代码：</p><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    res.send(<span class="string">'The image:index controller '</span> + req.params.image_id);</span><br><span class="line">[tuture-add]    res.render(<span class="string">'image'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The image:create POST controller'</span>);</span><br></pre></td></tr></table></figure><p>最后，不要忘记在 server/configure.js 模块中配置 handlebars 中间件：</p><figure class="highlight js"><figcaption><span>server/configure.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">[tuture-add]  app.engine(<span class="string">'handlebars'</span>, exphbs());</span><br><span class="line">[tuture-add]  app.set(<span class="string">'view engine'</span>, <span class="string">'handlebars'</span>);</span><br><span class="line">[tuture-add]</span><br><span class="line">  app.use(morgan(<span class="string">'dev'</span>));</span><br><span class="line">  app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">  app.use(bodyParser.json());</span><br></pre></td></tr></table></figure><p>大功告成！现在运行服务器，分别访问主页（<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDozMDAw" title="http://localhost:3000">http://localhost:3000<i class="fa fa-external-link"></i></span>）和图片详情页面（<span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDozMDAwL2ltYWdlcy90ZXN0" title="http://localhost:3000/images/test">http://localhost:3000/images/test<i class="fa fa-external-link"></i></span>），可以看到完整的页面（虽然没有数据），包括所有页面共享的头部和每个页面的自定义内容。</p><h2 id="完善界面代码"><a href="#完善界面代码" class="headerlink" title="完善界面代码"></a>完善界面代码</h2><p>在上面一步的基础上，我们将继续完善模板代码。</p><p>首先是在 index.handlebars 中添加上传图片的表单和展示最新图片的容器。</p><figure class="highlight handlebars"><figcaption><span>views/index.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml">[tuture-del]<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Index Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-primary"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      上传图片</span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/images"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body form-horizontal"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-md-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"file"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>浏览:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-10"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"file"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-md-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"title"</span> <span class="attr">class</span>=<span class="string">"col-md-2 control-label"</span>&gt;</span>标题:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-10"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"title"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-md-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"description"</span> <span class="attr">class</span>=<span class="string">"col-md-2 control-label"</span>&gt;</span>描述:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-10"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">rows</span>=<span class="string">"2"</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-md-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12 text-right"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"login-btn"</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-cloud-upload"</span>&gt;</span> 上传图片<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]</span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      最新图片</span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> images&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-center"</span> <span class="attr">style</span>=<span class="string">"padding-bottom: 1em;"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/images/</span></span></span><span class="template-variable">&#123;&#123;uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/public/upload/</span></span></span><span class="template-variable">&#123;&#123;filename&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">alt</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123;title&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span></span></span></span><br><span class="line"><span class="xml">[tuture-add]            style="width: 175px; height: 175px;" class="img-thumbnail"&gt;</span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>在展示最新图片时，我们用到了 handlebars 提供的循环语法（第 46 行到 53 行）。对于传入模板的数据对象 <code>images</code> 进行遍历，每个循环中可以访问单个 <code>image</code> 的全部属性，例如 <code>uniqueId</code> 等等。</p><p>接着完善 image.handlebars 的内容，包括展示图片的详细内容、发表评论的表单和展示所有评论的容器。</p><figure class="highlight handlebars"><figcaption><span>views/image.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml">[tuture-del]<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Image Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-primary"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.title&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.description&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12 text-center"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/public/upload/</span></span></span><span class="template-variable">&#123;&#123;image.filename&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">alt</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123;image.title&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span></span></span></span><br><span class="line"><span class="xml">[tuture-add]        class="thumbnail"&gt;</span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-footer"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">id</span>=<span class="string">"btn-like"</span> <span class="attr">data-id</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123;image.uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-heart"</span>&gt;</span> 点赞<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">"likes-count"</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.likes&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &amp;nbsp; - &amp;nbsp;</span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-eye"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">strong</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.views&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        &amp;nbsp; - &amp;nbsp; 发表于: <span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">em</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-right"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-danger"</span> <span class="attr">id</span>=<span class="string">"btn-delete"</span> <span class="attr">data-id</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123;image.uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-times"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]</span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span>评论<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-right"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-default btn-sm"</span> <span class="attr">id</span>=<span class="string">"btn-comment"</span> <span class="attr">data-id</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123;image.uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-comments-o"</span>&gt;</span> 发表评论...<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">blockquote</span> <span class="attr">id</span>=<span class="string">"post-comment"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/images/</span></span></span><span class="template-variable">&#123;&#123;image.uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">/comment"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-sm-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"name"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>昵称:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-sm-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"email"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>Email:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">name</span>=<span class="string">"email"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-sm-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"comment"</span> <span class="attr">class</span>=<span class="string">"col-sm-2 control-label"</span>&gt;</span>评论:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-10"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]              <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"comment"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">rows</span>=<span class="string">"2"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group col-sm-12"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-12 text-right"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]              <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-success"</span> <span class="attr">id</span>=<span class="string">"comment-btn"</span> <span class="attr">type</span>=<span class="string">"button"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]                <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-comment"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> 发表</span></span><br><span class="line"><span class="xml">[tuture-add]              <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">blockquote</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"media-list"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> comments&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"media"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">class</span>=<span class="string">"pull-left"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://www.gravatar.com/avatar/</span></span></span><span class="template-variable">&#123;&#123;gravatar&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">?d=monsterid&amp;s=45"</span></span></span></span><br><span class="line"><span class="xml">[tuture-add]            class="media-object img-circle"&gt;</span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"media-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          </span><span class="template-variable">&#123;&#123;comment&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">"media-heading"</span>&gt;</span></span><span class="template-variable">&#123;&#123;name&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>在展示所有评论的代码中，我们同样用到了 handlebars 的循环语法，非常方便。</p><p>然后，我们将分别实现网站右边栏中的统计数据、最受欢迎图片和最新评论组件。首先是统计数据组件模板：</p><figure class="highlight handlebars"><figcaption><span>views/partials/stats.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span>统计数据<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-left"</span>&gt;</span>图片:<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 text-right"</span>&gt;</span></span><span class="template-variable">&#123;&#123;sidebar.stats.images&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-left"</span>&gt;</span>评论:<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 text-right"</span>&gt;</span></span><span class="template-variable">&#123;&#123;sidebar.stats.comments&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-left"</span>&gt;</span>浏览:<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 text-right"</span>&gt;</span></span><span class="template-variable">&#123;&#123;sidebar.stats.views&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-left"</span>&gt;</span>点赞:<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 text-right"</span>&gt;</span></span><span class="template-variable">&#123;&#123;sidebar.stats.likes&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>可以看出组件模板和页面模板并没有什么不同，都是一些 HTML 代码再加上数据接口。</p><p>再分别实现最受欢迎图片组件（popular.handlebars）和最新评论组件（comments.handlebars）。</p><figure class="highlight handlebars"><figcaption><span>views/partials/popular.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span>最受欢迎<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> sidebar.popular&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-center"</span> <span class="attr">style</span>=<span class="string">"padding-bottom: .5em;"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/images/</span></span></span><span class="template-variable">&#123;&#123;uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/public/upload/</span></span></span><span class="template-variable">&#123;&#123;filename&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">style</span>=<span class="string">"width: 75px; height: 75px;"</span></span></span></span><br><span class="line"><span class="xml">            class="img-thumbnail"&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><figure class="highlight handlebars"><figcaption><span>views/partials/comments.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel panel-default"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-heading"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">"panel-title"</span>&gt;</span>最新评论<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"panel-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"media-list"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> sidebar.comments&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"media"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/images/</span></span></span><span class="template-variable">&#123;&#123;image.uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">class</span>=<span class="string">"pull-left"</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/public/upload/</span></span></span><span class="template-variable">&#123;&#123;image.filename&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span> <span class="attr">class</span>=<span class="string">"media-object"</span></span></span></span><br><span class="line"><span class="xml">            height="45" width="45"&gt;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"media-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">          </span><span class="template-variable">&#123;&#123;comment&#125;&#125;</span><span class="xml"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">"media-heading"</span>&gt;</span></span><span class="template-variable">&#123;&#123;name&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>最后，我们在布局模板 layouts/main.handlebars 中加入所有组件模板，加入模板的语法为 <code>{{> component this}}</code>。除此之外，由于我们用到了一些小图标，所以加上 font-awesome 的链接。</p><figure class="highlight handlebars"><figcaption><span>views/layouts/main.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Instagrammy<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-omit]</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-8"</span>&gt;</span></span><span class="template-variable">&#123;&#123;&#123;body&#125;&#125;</span><span class="xml">&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-sm-4"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        </span><span class="template-variable">&#123;&#123;&gt; stats this&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]        </span><span class="template-variable">&#123;&#123;&gt; popular this&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]        </span><span class="template-variable">&#123;&#123;&gt; comments this&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">[tuture-add]      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>在实际开发中，我们可能经常需要调整页面代码。在修改并保存模板后，只需刷新浏览器即可看到界面的变化（但是如果修改服务器代码则需要重新运行服务器）。</p><h2 id="将数据传入模板视图"><a href="#将数据传入模板视图" class="headerlink" title="将数据传入模板视图"></a>将数据传入模板视图</h2><p>如果没有数据传入，那么模板相应的数据部分将全都是空白。在这一步中，我们将用一些假数据来演示如何从控制器将数据传入模板视图。</p><p>首先在 home 控制器中构造一个 <code>viewModel</code> 对象，并在 <code>render</code> 函数中作为第二参数传入。可以看到 <code>viewModel</code> 对象与模板中的数据接口是完全一致的。</p><figure class="highlight js"><figcaption><span>controllers/home.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    res.render(<span class="string">'index'</span>);</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> viewModel = &#123;</span><br><span class="line">[tuture-add]      images: [</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          uniqueId: <span class="number">1</span>,</span><br><span class="line">[tuture-add]          title: <span class="string">'示例图片1'</span>,</span><br><span class="line">[tuture-add]          description: <span class="string">''</span>,</span><br><span class="line">[tuture-add]          filename: <span class="string">'sample1.jpg'</span>,</span><br><span class="line">[tuture-add]          views: <span class="number">0</span>,</span><br><span class="line">[tuture-add]          likes: <span class="number">0</span>,</span><br><span class="line">[tuture-add]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          uniqueId: <span class="number">2</span>,</span><br><span class="line">[tuture-add]          title: <span class="string">'示例图片2'</span>,</span><br><span class="line">[tuture-add]          description: <span class="string">''</span>,</span><br><span class="line">[tuture-add]          filename: <span class="string">'sample2.jpg'</span>,</span><br><span class="line">[tuture-add]          views: <span class="number">0</span>,</span><br><span class="line">[tuture-add]          likes: <span class="number">0</span>,</span><br><span class="line">[tuture-add]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          uniqueId: <span class="number">3</span>,</span><br><span class="line">[tuture-add]          title: <span class="string">'示例图片3'</span>,</span><br><span class="line">[tuture-add]          description: <span class="string">''</span>,</span><br><span class="line">[tuture-add]          filename: <span class="string">'sample3.jpg'</span>,</span><br><span class="line">[tuture-add]          views: <span class="number">0</span>,</span><br><span class="line">[tuture-add]          likes: <span class="number">0</span>,</span><br><span class="line">[tuture-add]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]      ],</span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]    res.render(<span class="string">'index'</span>, viewModel);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>同理实现 image 控制器。</p><figure class="highlight js"><figcaption><span>controllers/image.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  index: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">[tuture-del]    res.render(<span class="string">'image'</span>);</span><br><span class="line">[tuture-add]    <span class="keyword">const</span> viewModel = &#123;</span><br><span class="line">[tuture-add]      image: &#123;</span><br><span class="line">[tuture-add]        uniqueId: <span class="number">1</span>,</span><br><span class="line">[tuture-add]        title: <span class="string">'示例图片1'</span>,</span><br><span class="line">[tuture-add]        description: <span class="string">'这是张测试图片'</span>,</span><br><span class="line">[tuture-add]        filename: <span class="string">'sample1.jpg'</span>,</span><br><span class="line">[tuture-add]        views: <span class="number">0</span>,</span><br><span class="line">[tuture-add]        likes: <span class="number">0</span>,</span><br><span class="line">[tuture-add]        timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-add]      &#125;,</span><br><span class="line">[tuture-add]      comments: [</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          image_id: <span class="number">1</span>,</span><br><span class="line">[tuture-add]          email: <span class="string">'test@testing.com'</span>,</span><br><span class="line">[tuture-add]          name: <span class="string">'Test Tester'</span>,</span><br><span class="line">[tuture-add]          comment: <span class="string">'Test 1'</span>,</span><br><span class="line">[tuture-add]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]        &#123;</span><br><span class="line">[tuture-add]          image_id: <span class="number">1</span>,</span><br><span class="line">[tuture-add]          email: <span class="string">'test@testing.com'</span>,</span><br><span class="line">[tuture-add]          name: <span class="string">'Test Tester'</span>,</span><br><span class="line">[tuture-add]          comment: <span class="string">'Test 2'</span>,</span><br><span class="line">[tuture-add]          timestamp: <span class="built_in">Date</span>.now(),</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]      ],</span><br><span class="line">[tuture-add]    &#125;;</span><br><span class="line">[tuture-add]    res.render(<span class="string">'image'</span>, viewModel);</span><br><span class="line">  &#125;,</span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'The image:create POST controller'</span>);</span><br></pre></td></tr></table></figure><p>在传入数据时，我们可以自定义一些 helper 函数在模板中使用。例如 timestamp 时间戳，<code>Date.now()</code> 返回的是一串数字，显然用户体验很不友好，因此我们需要将其转换为方便用户阅读的时间，例如“几秒前”“两小时前”。这里我们选用 JavaScript 最流行的处理时间的库 <span class="exturl" data-url="aHR0cDovL21vbWVudGpzLmNuLw==" title="http://momentjs.cn/">moment.js<i class="fa fa-external-link"></i></span>，并通过 npm 安装：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ npm install moment</span><br></pre></td></tr></table></figure><p>然后在 server/configure.js 中配置 handlebars 的 helper 函数 <code>timeago</code>：</p><figure class="highlight js"><figcaption><span>server/configure.js</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"><span class="keyword">const</span> methodOverride = <span class="built_in">require</span>(<span class="string">'method-override'</span>);</span><br><span class="line"><span class="keyword">const</span> errorHandler = <span class="built_in">require</span>(<span class="string">'errorhandler'</span>);</span><br><span class="line">[tuture-add]<span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">'./routes'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</span><br><span class="line">[tuture-del]  app.engine(<span class="string">'handlebars'</span>, exphbs());</span><br><span class="line">[tuture-add]  <span class="comment">// 定义 moment 全局语言</span></span><br><span class="line">[tuture-add]  moment.locale(<span class="string">'zh-cn'</span>);</span><br><span class="line">[tuture-add]</span><br><span class="line">[tuture-add]  app.engine(</span><br><span class="line">[tuture-add]    <span class="string">'handlebars'</span>,</span><br><span class="line">[tuture-add]    exphbs.create(&#123;</span><br><span class="line">[tuture-add]      helpers: &#123;</span><br><span class="line">[tuture-add]        timeago: <span class="function"><span class="keyword">function</span>(<span class="params">timestamp</span>) </span>&#123;</span><br><span class="line">[tuture-add]          <span class="keyword">return</span> moment(timestamp).startOf(<span class="string">'minute'</span>).fromNow();</span><br><span class="line">[tuture-add]        &#125;,</span><br><span class="line">[tuture-add]      &#125;,</span><br><span class="line">[tuture-add]    &#125;).engine,</span><br><span class="line">[tuture-add]  );</span><br><span class="line">  app.set(<span class="string">'view engine'</span>, <span class="string">'handlebars'</span>);</span><br><span class="line"></span><br><span class="line">  app.use(morgan(<span class="string">'dev'</span>));</span><br></pre></td></tr></table></figure><p><code>timeago</code> 函数能够在模板中使用，将原始的 UNIX 时间戳转换为易于理解的中文时间戳。</p><p>接着在相应用到时间戳的地方加入 <code>timeago</code> 函数：</p><figure class="highlight handlebars"><figcaption><span>views/image.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">"likes-count"</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.likes&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span> &amp;nbsp; - &amp;nbsp;</span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-eye"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">strong</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.views&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-del]        &amp;nbsp; - &amp;nbsp; 发表于: <span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;image.timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">em</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]        &amp;nbsp; - &amp;nbsp; 发表于: <span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;timeago image.timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">em</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 text-right"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-danger"</span> <span class="attr">id</span>=<span class="string">"btn-delete"</span> <span class="attr">data-id</span>=<span class="string">"</span></span></span><span class="template-variable">&#123;&#123;image.uniqueId&#125;&#125;</span><span class="xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-omit]</span></span><br><span class="line"><span class="xml">          </span><span class="template-variable">&#123;&#123;comment&#125;&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">"media-heading"</span>&gt;</span></span><span class="template-variable">&#123;&#123;name&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-del]          <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;timeago timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><figure class="highlight handlebars"><figcaption><span>views/partials/comments.handlebars</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"media-body"</span>&gt;</span></span></span><br><span class="line"><span class="xml">          </span><span class="template-variable">&#123;&#123;comment&#125;&#125;</span><span class="xml"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">strong</span> <span class="attr">class</span>=<span class="string">"media-heading"</span>&gt;</span></span><span class="template-variable">&#123;&#123;name&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-del]          <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span></span><br><span class="line"><span class="xml">[tuture-add]          <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span></span><span class="template-variable">&#123;&#123;timeago timestamp&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">small</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">      </span><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span><span class="xml"></span></span><br></pre></td></tr></table></figure><p>至此，本系列教程的第一部分就已经完成了，MVC 我们实现了 V（视图）和 C （控制器）。在后续教程中，我们将接入 MongoDB 数据库用于网站数据的存取，并进一步实现图片上传、点赞和删除，以及添加评论等功能。</p>]]></content>
    
    <summary type="html">
    
      Node.js 已经成为服务器端开发的主流选择之一，而 Express 则是 Node 平台最耀眼的那个框架。在这篇教程中，我们将用 Node.js 中最流行的 Express 框架搭建一个类似 Instagram 的图片分享社区，数据库选用 当今颇受欢迎的非关系型数据库 MongoDB。本教程的代码改编自 Mithun Satheesh，Bruno Joseph D&#39;mello 和 Jason Krol 的《Web Development with MongoDB and NodeJS: Second Edition》一书。
    
    </summary>
    
    
    
      <category term="Node" scheme="https://tuture.co/tags/Node/"/>
    
      <category term="MongoDB" scheme="https://tuture.co/tags/MongoDB/"/>
    
      <category term="Express" scheme="https://tuture.co/tags/Express/"/>
    
  </entry>
  
</feed>
